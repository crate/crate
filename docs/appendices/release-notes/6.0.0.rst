.. _version_6.0.0:

==========================
Version 6.0.0 - Unreleased
==========================

.. comment 1. Remove the " - Unreleased" from the header above and adjust the ==
.. comment 2. Remove the NOTE below and replace with: "Released on 20XX-XX-XX."
.. comment    (without a NOTE entry, simply starting from col 1 of the line)
.. NOTE::
    In development. 6.0.0 isn't released yet. These are the release notes for
    the upcoming release.

.. NOTE::

    If you are upgrading a cluster, you must be running CrateDB 5.0.0 or higher
    before you upgrade to 6.0.0.

    We recommend that you upgrade to the latest 5.10 release before moving to
    6.0.0.

    A rolling upgrade from >= 5.10.1 to 6.0.0 is supported.
    Before upgrading, you should `back up your data`_.

.. WARNING::

    Tables that were created before CrateDB 5.x will not function with 6.x
    and must be recreated before moving to 6.x.x.

    You can recreate tables using ``COPY TO`` and ``COPY FROM`` or by
    `inserting the data into a new table`_.

.. _back up your data: https://crate.io/docs/crate/reference/en/latest/admin/snapshots.html
.. _inserting the data into a new table: https://crate.io/docs/crate/reference/en/latest/admin/system-information.html#tables-need-to-be-recreated

.. rubric:: Table of contents

.. contents::
   :local:

.. _version_6.0.0_breaking_changes:

Breaking Changes
================

- Updated Lucene from 9.12 to 10.0 which brings the following user facing changes:

  - Tables created in 4.x can't be read anymore. If you're running CrateDB 5.x
    and have any tables created in 4.x they need to be reindexed before moving
    to CrateDB 6.0. Make sure there are no warnings in the admin console and see
    :ref:`table_version_compatibility` for more information.

  - The ``dutch_kp`` and ``lovins`` token filters are no longer available. If
    users have tables which use these token filters for analysis, they will need
    to re-index with either plain ``dutch`` or ``english`` stemmers before
    upgrading.

  - The ``german2`` and ``german`` token filters now use the same underlying stemmer,
    which always expands ``ä``, ``ö`` and ``ü`` to ``ae``, ``oe`` and ``ue`` respectively.
    If users have tables which were using the ``german`` stemmer without a character
    filter that already did this, they will need to re-index after upgrading.

- Removed the deprecated ``soft_deletes.enabled`` setting for ``CREATE TABLE``.
  The setting defaulted to ``true`` since 4.3.0, was deprecated in 4.5.0 and
  soft deletes became mandatory in 5.0.0.

- When casting an expression of type :ref:`OBJECT <type-object>` to an
  :ref:`OBJECT <type-object>`, the inner types are merged instead of being
  replaced by the target type and the target
  :ref:`column policy <type-object-column-policy>` is used. The only exception
  is when the target column policy is set to
  :ref:`STRICT <type-object-columns-strict>`. In this case, only the target
  inner type definition is used. See also the related
  :ref:`documentation <cast_to_object>`

Deprecations
============

 - Usage of :ref:`_version<sql_administration_system_column_version>` has been
   deprecated completely. Please note that its usage for :ref:`sql_occ` has
   already been deprecated since :ref:`version_4.0.0`.


Changes
=======

SQL Statements
--------------

SQL Standard and PostgreSQL Compatibility
-----------------------------------------

- Added support for lower case format patterns to the
  :ref:`to_char <scalar-to_char>` scalar function.

- Added the :ref:`information_schema.applicable_roles <applicable_roles>`,
  :ref:`information_schema.enabled_roles <enabled_roles>`,
  :ref:`information_schema.administrable_role_authorizations <administrable_role_authorizations>`
  and :ref:`information_schema.role_table_grants <role_table_grants>` tables.

- Populated the ``pg_index.indnkeyatts`` column with the number of key
  attributes in the primary key.

Data Types
----------

- Added support for dynamic mapping of nested arrays.

- Improved error handling of missing keys when accessing elements of (nested)
  :ref:`object type<type-object>` expressions to be consistent according to the
  defined :ref:`type-object-column-policy` and the related
  :ref:`conf-session-error_on_unknown_object_key` session setting.

Scalar and Aggregation Functions
--------------------------------

- Added support for the :ref:`array_overlap<scalar-array_overlap>` scalar
  function and the associated :ref:`&&<array_overlap_operator>` operator.

- Added support for the :ref:`aggregation-stddev-pop` function to compute
  the population standard deviation.


Performance and Resilience Improvements
---------------------------------------

- Improved the performance for ``SELECT COUNT(not_null_column) FROM tbl``. It is
  now executed the same way as ``SELECT COUNT(*) FROM tbl``.

- Improved the handling of temporary unavailable shards during read-only
  queries. There's now a higher chance that the system can deal with the
  temporary failure without surfacing the error to the client.

- Improved execution for queries with mixed implicit and explicit joins.
  Joins are now always executed in the original order of the query.

- Improved the performance of the queries involving ``= ALL`` array operator.

- Improved the performance of :ref:`shard recovery<gloss-shard-recovery>` in
  certain cases, where a shard has become idle after 5 minutes of no write
  activity.

- Increased the frequency of retention lease synchronization, which will make
  merges more likely to be able to remove recovery source.

Administration and Operations
-----------------------------

- Added ``merge_id`` and ``fully_merged_docs`` columns to the sys.segments table
  to give more information on ongoing merges and whether the recovery source is
  still present in merged segments.

Client interfaces
-----------------
