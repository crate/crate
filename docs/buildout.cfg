[buildout]
versions = versions
extends = versions.cfg
extensions = lovely.buildouthttp
show-picked-versions = true
parts = sphinx
        sphinx-cmd
        test
        crate-python
        crate-python-docs
find-links = http://download.crate.io/eggs/


[test]
recipe = zc.recipe.egg:script
relative-paths = true
entry-points=test=zope.testrunner:run
eggs = zope.testrunner
       crate [test, sqlalchemy]
       zc.customdoctests
initialization=
 sys.path.append('${buildout:directory}/src')
 sys.argv.extend(['--auto-color',
                  '--test-path', join(base, 'src'),])

[sphinx]
recipe = zc.recipe.egg:script
eggs = sphinx
       crate [test, sqlalchemy]  # required for sphinx-apidoc
       crate_theme
relative-paths=true

[sphinx-cmd]
recipe = lovely.recipe:mkfile
path = ${buildout:bin-directory}/sphinx
mode = 0755
content = #!/bin/sh
          declare -i RESULT=0
          EGG_PATH=$(find ${test:eggs-directory} -name "crate-${versions:crate}*.egg")
          ${buildout:bin-directory}/sphinx-apidoc -s txt -o crate-python $EGG_PATH
          RESULT+=$?
          ${buildout:bin-directory}/sphinx-build -b html -E . ${buildout:directory}/out/html
          RESULT+=$?
          ${buildout:bin-directory}/sphinx-build -b text -E . ${buildout:directory}/out/text
          RESULT+=$?
          exit $RESULT

[crate-python]
recipe = hexagonit.recipe.download
url = https://download.crate.io/eggs/crate-${versions:crate}.tar.gz
strip-top-level-dir = true


[crate-python-docs]
recipe = collective.recipe.cmd
on_install=true
on_update=true
cmds =
    test -d ${buildout:directory}/crate-python || mkdir ${buildout:directory}/crate-python
    ln -sfn ${crate-python:location}/docs/client.txt ${buildout:directory}/crate-python/client.txt
    ln -sfn ${crate-python:location}/docs/blobs.txt ${buildout:directory}/crate-python/blobs.txt
    ln -sfn ${crate-python:location}/docs/sqlalchemy.txt ${buildout:directory}/crate-python/sqlalchemy.txt
