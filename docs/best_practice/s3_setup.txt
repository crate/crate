.. highlight:: yaml
.. _s3_setup:

=========================
Crate Setup for Amazon S3
=========================

You can create CRATE *Snapshots* on the `Amazon S3`_ (Amazon Simple Storage
Service). For this, you need to register the `AWS` plugin with CRATE.


Basic Configuration
===================

Support for *Snapshot* and *Restore* to the `Amazon S3`_ service is enabled by
default in Crate. If you need to explicitly turn it off, disable the
cloud setting in the ``crate.yml`` file::

  cloud.enabled: false

To be able to use the S3 API, Crate must `sign the requests`_ by using
AWS credentials consisting of an access key and a secret key. Therefore
AWS provides `IAM roles`_ to avoid any distribution of your AWS credentials
to the instances.

.. _s3_authentication:

Authentication
--------------

It is recommended to restrict the permissions of Crate on the S3 to only the
required extend. First, you need to create an IAM role. This `AWS guide`_
gives you a short description of how you can create a policy offer CLI or
the AWS management console. You need to restrict access of the snapshot to
the S3 bucket you wish to use. An example policy file granting access to
to anybody to a bucket called `snaps.example.com`` is attached below:

.. code-block:: json

  {
    "Statement": [
      {
        "Action": [
          "s3:ListBucket",
          "s3:GetBucketLocation",
          "s3:ListBucketMultipartUploads",
          "s3:ListBucketVersions"
        ],
        "Effect": "Allow",
        "Principal": "*",
        "Resource": [
          "arn:aws:s3:::snaps.example.com"
        ]
      },
      {
        "Action": [
          "s3:GetObject",
          "s3:PutObject",
          "s3:DeleteObject",
          "s3:AbortMultipartUpload",
          "s3:ListMultipartUploadParts"
        ],
        "Effect": "Allow",
        "Principal": "*",
        "Resource": [
          "arn:aws:s3:::snaps.example.com/*"
        ]
      }
    ],
    "Version": "2012-10-17"
  }

You might want to restrict access permissions to a specific AWS Principal by
changing the ``Statement.Principal`` setting. Please refer to `AWS principals`_
for more information.

For further AWS policy examples and detailed information, please refer to
`AWS policy examples`_ and the links therein.

It has to be noted, that the bucket needs to exist before registering a
repository for snapshots within Crate. You can also allow Crate to create
the bucket for you. However this requires the following permissions to be
contained within the policy:

.. code-block:: json

  {
     "Action": [
        "s3:CreateBucket"
     ],
     "Effect": "Allow",
     "Resource": [
        "arn:aws:s3:::snaps.example.com"
     ]
  }


.. _`Amazon S3`: http://aws.amazon.com/s3
.. _`sign the requests`: http://docs.aws.amazon.com/general/latest/gr/signing_aws_api_requests.html
.. _`IAM roles`: http://docs.aws.amazon.com/IAM/latest/UserGuide/id_roles.html
.. _`AWS guide`: http://docs.aws.amazon.com/AWSEC2/latest/UserGuide/iam-roles-for-amazon-ec2.html
.. _`AWS principals`: http://docs.aws.amazon.com/IAM/latest/UserGuide/reference_policies_elements.html#Principal
.. _`AWS policy examples`: http://docs.aws.amazon.com/AmazonS3/latest/dev/example-bucket-policies.html
