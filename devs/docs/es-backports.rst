======================================
Backporting changes from Elasticsearch
======================================

With CrateDB 4.0.0 we integrated the Elasticsearch code and then pruned out
everything we don't use.

With CrateDB 4.2.0 we changed the module structure, so that Elasticsearch and
CrateDB code is no longer split, but mixed within the same modules. The
majority is in ``server``.


We still want to keep many of the components up-to-date, while other components
will converge more and more over time.

Areas were we want to stay close to Elasticsearch upstream are mostly:

- Engine
- Snapshotting
- Recovery
- Discovery and master election


Applied change sets
===================

Patches should be applied in order. A backport commit message should be
prefixed with ``bp:``, this allows us to verify if a patch was applied later on
using something like this::

    sh$ git log --oneline --grep 'bp:'


If a patch is skipped, use the ``sp:`` prefix instead.

To see if there are new changes you can use
``git log`` in the Elasticsearch repository, like so::

    sh$ git log --oneline ca5771c1f4a.. -- server/src/main/java/org/elasticsearch/index/{engine,snapshots,store,translog,shard,seqno,mapper,codec}/

Here ``ca5771c1f4a`` is the starting point, it shows any changes since then that
affected files in the given folder.

(Note that there may be changes before ``ca5771c1f4a`` that are missing)

We should eventually bump the reference point, once all patches have been
applied to a certain point.

Below lists the change sets we applied. This should be updated whenever a
backport is made. If a patch is skipped because it is not applicable, it should
be crossed out as well. ``x`` is used to mark applied patches, ``s`` for
skipped patches if they're no applicable - for example if the functionality is
not present in CrateDB. ``d`` marks a delayed patch - a change we should apply,
but which is non-trivial to apply and at the same time doesn't affect too any
components, so delaying it doesn't make applying other patches more difficult.


- [ ] 423bcd3c14d Remove typename validation (typename is always ) (#60133)
- [ ] 198b2d6654f ParametrizedFieldMapper to run validators against default value (#60042)
- [ ] 4ef33425d25 Wrap up building parametrized TypeParsers (#59977)
- [ ] 1cf9eac4045 Tweak toXContent implementation of ParametrizedFieldMapper (#59968)
- [ ] 98698f569d2 Drop some params from IndexFieldData.Builder (#59934)
- [ ] d4e315531ab Simplify structure for parsing points. (#59815)
- [ ] 6130ecc1731 Small cleanup for IndexFieldData (#59724)
- [ ] 42377c77299 Shortcut mapping update if the incoming mapping version is the same as the current mapping version (#59517)
- [ ] b9854165f34 Fix merge error
- [ ] bf12ac13333 Convert DateFieldMapper to parametrized format (#59429)
- [ ] 8bcca0c7a1d Preserve old serialization for CompletionFieldMapper (#59550)
- [ ] 678ae31d1d6 Fix compilation in Eclipse (#59675)
- [ ] fd88ab13419 Correct type parametrization in geo mappers. (#59583)
- [ ] b083bafa786 Make MappedFieldType#meta final (#59383)
- [ ] dc91a300700 Move getPointReaderOrNull into AggregatorBase (#58769)
- [ ] b87bb86d88d Adding indexing pressure stats to node stats API (#59247)
- [ ] 24786ac71b8 Migrate CompletionFieldMapper to parametrized format (#59291)
- [ ] 33630489dbf Continue to accept unused 'universal' params in <8.0 indexes (#59381)
- [ ] 40b9fd49e02 Make data streams a basic licensed feature. (#59293)
- [ ] 4c1b081e270 Fix estimate size of translog operations (#59206)
- [ ] 62f51eb9aec MappedFieldType no longer requires equals/hashCode/clone (#59212)
- [ ] 219b7dbd12f Add declarative parameters to FieldMappers (#58663)
- [ ] cb6b05d12b9 Fix the timestamp field of a data stream to @timestamp (#59076)
- [ ] 31a569a60a2 Remove uid from translog delete operation (#59101)
- [ ] 90e72a4194e Avoid flipping translog header version (#58866)
- [ ] 52ff121fcfc Re-enable support for array-valued geo_shape fields. (#58786)
- [ ] 673444000e3 Percolator keyword fields should not store norms (#58899)
- [ ] 001b3fb4406 Add data stream timestamp validation via metadata field mapper (#58582)
- [ ] 69c7e73b665 Drop rewriting in date_histogram (#57836)
- [ ] 3944066e992 Move MappedFieldType#getSearchAnalyzer and #getSearchQuoteAnalyzer to TextSearchInfo (#58639)
- [ ] dcd723a6b19 Enable BWC tests after backport of #58029 (#58815)
- [ ] ee79ae072ba Week based parsing for ingest date processor (#58597)
- [ ] 83d6589b2ae Account for remaining recovery in disk allocator (#58029)
- [ ] 118521d0223 Account for recovery throttling when restoring snapshot (#58658)
- [ ] 676893a2632 Merge mappings for composable index templates (#58521)
- [ ] 9bef31ccd3a Do not create two loggers for DeprecationLogger (#58435)
- [ ] 7d64b71a05d Simplify Serialization of ForceMergeRequest (#58470)
- [ ] c16a4553cb2 Add memory tracking to queued write operations (#57573)
- [ ] cdc1be144bf Field capabilities - make `keyword` a family of field types (#58315)
- [ ] 83ce7a96915 Move MappedFieldType.similarity() to TextSearchInfo (#58439)
- [ ] 57316e26af6 Add text search information to MappedFieldType (#58230)
- [ ] 3cbe56463ed Make FieldTypeLookup immutable (#58162)
- [ ] 409306e01db Correct default formatting of binary fields (#58338)
- [ ] 708f6bf8795 Add serialization test for FieldMappers when include_defaults=true (#58235)
- [ ] 09ff747fe74 Remove Settings parameter from FieldMapper base class (#58237)
- [ ] 0c3dd945338 Add new extensions for Lucene86 points codec to FsDirectoryFactory (#58226)
- [ ] 1d62d7d663f Don't log on RetentionLeaseSync error handler (#58098)
- [ ] c7cbf80dfc9 Remove needless termsQuery implementation from StringFieldType (#57609)
- [ ] bf910e91328 Fix recovery stage transition with sync_id (#57754)
- [ ] 3b696828ada MappedFieldType should not extend FieldType (#57666)
- [ ] 4263de790aa Hide AlreadyClosedException on IndexCommit release (#57986)
- [ ] e19a82d7628 Update to lucene snapshot e7c625430ed (#57981)
- [ ] 8c8253d251f Minor Cleanup Dead Code Snapshotting (#57716)
- [ ] b68bd78a53a Refactor how to determine if a field is metafield (#57378)
- [ ] 88a2aeb8cf6 Remove the 'array value parser' marker interface. (#57571)
- [ ] 0a23487e73e IndexFieldData should hold the ValuesSourceType (#57373)
- [ ] 6477924c262 Store parsed mapping settings in IndexSettings (#57492)
- [ ] 4d6dc51c729 Header warning logging refactoring (#55941)
- [ ] 2ef82cd7f95 Fix Local Translog Recovery not Updating Safe Commit in Edge Case (#57350)
- [ ] 99871b18d64 Catch InputCoercionException thrown by Jackson parser (#57287)
- [ ] 86b64e4c39e Remove unused logic from FieldNamesFieldMapper. (#56834)
- [ ] fed71fbd669 Remove Mapper.updateFieldType() (#56986)
- [ ] 2787eadb1ac Flatten ReleaseableBytesReference Object Trees (#57092)
- [ ] 9a49075d0c9 Simplify range query methods for range types. (#56976)
- [ ] f82d74b5017 Move merge compatibility logic from MappedFieldType to FieldMapper (#56915)
- [ ] 0cc2345f98d Simplify generics on Mapper.Builder (#56747)
- [ ] 7b34e22890e Use index sort range query when possible. (#56657)
- [ ] 954afd94fe8 Clean up DocValuesIndexFieldData (#56372)
- [ ] e62fb090fa5 upgrade to Lucene 8.6.0 snapshot (#56175)
- [ ] a01d2bd24b0 [Geo] Refactor Point Field Mappers (#56060)
- [ ] fa535d08b50 Use CollectionUtils.isEmpty where appropriate (#55910)
- [ ] e1dbe2606ce Use snapshot information to build searchable snapshot store MetadataSnapshot (#56289)
- [ ] 77ac5d805bb Make sure to use ParseContext.Document#addAll when possible.
- [ ] 7a5d18ddc37 Simplify signature of FieldMapper#parseCreateField. (#56066)
- [ ] bb04fbcd969 For constant_keyword, make sure exists query handles missing values. (#55757)
- [ ] b2b32d7cf85 Retry failed replication due to transient errors (#55633)
- [ ] a508d3303d5 Ensure no circular reference in translog tragic exception (#55959)
- [ ] 8521ae52b1b Remove TODO around aggregating on _index.
- [ ] db288a29ec9 Ignore closed exception on refresh pending location listener (#55799)
- [ ] b2a15c62fb2 Return true for can_match on idle search shards (#55428)
- [ ] 43b8327b6e0 [Geo] fix GeoShapeWithDocValuesFieldMapper.doXContentBody
- [ ] eb0b2c8f699 Refactor Spatial Field Mappers (#55621)
- [ ] d6fb306c961 Allow searching of snapshot taken while indexing (#55511)
- [ ] 05066aecf07 Add Bulk stats track the bulk per shard (#52208)
- [ ] c2df6f911d1 Ensure not to open directory reader on transport thread (#55419)
- [ ] b78dfb07ae1 Add geo_shape mapper supporting doc-values in Spatial Plugin (#55037)
- [ ] 5c66caf21a9 Fix updating include_in_parent/include_in_root of nested field throwsâ€¦ (#54386)
- [ ] 8638d08ebf6 Always use deprecateAndMaybeLog for deprecation warnings (#55115)
- [ ] 3bfcc60cce6 Update translog policy before the next safe commit (#54839)
- [ ] f6feb6c2c84 Merge feature/searchable-snapshots branch into master (#54803)
- [ ] 150065182eb Disallow changing 'enabled' on the root mapper. (#54463)
- [ ] 95a7eed9aa3 Rename MetaData to Metadata in all of the places (#54519)
- [ ] a90c1de8745 Add ValuesSource Registry and associated logic (#54281)
- [ ] e9bc3e8234b Disallow negative TimeValues (#53913)
- [ ] f301f499184 Avoid I/O operations when rewriting shard search request (#54044)
- [ ] 2537e02a7db Wildcard field - add normalizer support (#53851)
- [ ] ec4c699defb Prevent SigTerms/SigText from running on fields they do not support (#52851)
- [ ] 87c910b36f8 Better Incrementality for Snapshots of Unchanged Shards (#52182)
- [ ] 856721c574d Handle properly indexing rectangles that crosses the dateline (#53810)
- [ ] 2794ab79753 Execute retention lease syncs under system context (#53838)
- [ ] 6eb698bc6d3 Add support for distance queries on geo_shape queries (#53466)
- [ ] d1cbdfb7530 Geo shape query vs geo point (#52382)
- [ ] e1096b9457c Restore off-heap loading for term dictionary in ReadOnlyEngine (#53713)
- [ ] 3e607d9e93c Rename AtomicFieldData to LeafFieldData (#53554)
- [ ] 01eee1a97f9 Highlighters skip ignored keyword values (#53408)
- [ ] 1fc3fe3d32f Fix Term Vectors with artificial docs and keyword fields (#53504)
- [ ] facd525b0a3 Mask wildcard query special characters on keyword queries (#53127)
- [ ] 352e59cc56f Fix doc_stats and segment_stats of ReadOnlyEngine (#53345)
- [ ] 713e931df4c Record Force Merges in Live Commit Data (#52694)
- [ ] a63232d2bc6 Fix date_nanos in composite aggs (#53315)
- [ ] 5d716bc16ce Upgrade to final lucene 8.5.0 snapshot (#53293)
- [ ] abdaf3ab2c5 Use given executor for global checkpoint listener (#53260)
- [ ] 04930e990aa Notify refresh listeners on the calling thread (#53259)
- [ ] 806046339d2 Early return if no global checkpoint listeners (#53036)
- [ ] f4223b6a8fa Add size support to `top_metrics` (#52662)
- [ ] 31b29875c9d Add validation for dynamic templates (#51233)
- [ ] 4943bc0cd39 HybridDirectory should mmap postings. (#52641)
- [ ] a3a98c7003e Cache completion stats between refreshes (#51991)
- [ ] 8830eb6b9a8 Generalize how queries on `_index` are handled at rewrite time (#52486)
- [ ] a789f74b769 Fix incorrect indentation in TextFieldMapper.
- [ ] 7684ae882c8 Improve the error message when loading text fielddata. (#52753)
- [ ] 2a95ecb7c18 Don't index ranges including NOW in percolator (#52748)
- [ ] f05b831e43a Comprehensively test supported/unsupported field type:agg combinations (#52493)
- [ ] 16af0472a98 Separate translog from index deletion conditions (#52556)
- [ ] cbd224d0701 Upgrade Lucene 8.5 to latest snapshot (#52520)
- [ ] b176cca607e Fix synchronization in ByteSizeCachingDirectory (#52512)
- [ ] f3b5bd951b0 Move the terms index of `_id` off-heap. (#52405)
- [ ] 30316d6d640 Refactor GeoShapeIndexer by extracting polygon / line decomposers (#52422)
- [ ] 403d1ff7008 Optimize FilterStreamInput for Network Reads (#52395)
- [ ] 5b2266601be Implement top_metrics agg (#51155)
- [ ] a8b39ed842c Add a cluster setting to disallow expensive queries (#51385)
- [ ] da2b67d6e5b Fix a DST error in date_histogram (#52016)
- [ ] 2c305810cc6 In FieldTypeLookup, factor out flat object field logic. (#52091)
- [ ] eb56c271b4c Don't Upload Redundant Shard Files (#51729)
- [ ] ebc46814732 Use local checkpoint to calculate min translog gen for recovery (#51905)
- [ ] 19174d6ef0d Cleanup some Dead Code in o.e.index.store (#52045)
- [ ] f38a4f5b9ad Remove references to mapping type in FieldTypeLookup. (#52026)
- [ ] e0b3ea04167 Rename MapperService#fullName to fieldType. (#52025)
- [ ] e79e6d9c1d0 Remove Redundant Loading of RepositoryData during Restore (#51977)
- [ ] 3c9996404f4 Remove the index.mapper.dynamic setting. (#51718)
- [ ] eb69c6fe7cf Always rewrite search shard request outside of the search thread pool (#51708)
- [ ] 7e85fc454eb Throw better exception on wrong `dynamic_templates` syntax (#51783)
- [ ] bf317e8c4eb Remove comparison to true for booleans (#51723)
- [ ] 7cec5f93bee Make `date_range` query rounding consistent with `date` (#50237)
- [ ] 0c87892b3db Remove sync flush logic in Engine (#51450)
- [ ] b034d1e2ef8 Remove translog retention policy (#51417)
- [ ] 5132715bc10 Do not wrap soft-deletes reader for segment stats (#51331)
- [ ] 151148622cb Exclude nested documents in LuceneChangesSnapshot (#51279)
- [ ] 1dc9dd42235 Add NestedPathFieldMapper to store nested path information (#51100)
- [ ] 573c7ddab18 Remove fieldMapper parameter from MetadataFieldMapper.TypeParser#getDefault() (#51219)
- [ ] 6e2f7b4b084 Use Lucene index in peer recovery and resync (#51189)
- [ ] c8e9f57348f Account soft-deletes in FrozenEngine (#51192)
- [ ] 3d796248437 Revert "Don't use user-supplied type when building DocumentMapper (#50960)" (#51214)
- [ ] 9bb7d21c0b0 Remove the AllFieldMapper from master (#51106)
- [ ] 09b46c86463 Goodbye and thank you synced flush! (#50882)
- [ ] 774bfb5e223 Don't use user-supplied type when building DocumentMapper (#50960)
- [ ] 5736dfb8c31 Warn on slow metadata performance (#50956)
- [ ] a0513217dba Move metadata storage to Lucene (#50907)
- [ ] 0510af87868 Do not force refresh when write indexing buffer (#50769)
- [ ] fdd413370ef Deleted docs disregarded for if_seq_no check (#50526)
- [ ] 4c1f1b2acab Declare remaining parsers `final` (#50571)
- [ ] 424ed93e38b Always use soft-deletes in InternalEngine (#50415)
- [ ] d02afccd983 Ensure relocating shards establish peer recovery retention leases (#50486)
- [ ] 5e0030e1306 Adjust BWC for peer recovery retention leases (#50351)
- [ ] cec6678587e Use peer recovery retention leases for indices without soft-deletes (#50351)
- [ ] 2d627ba7574 Add per-field metadata. (#49419)
- [ ] 74ff50f814a Omit loading IndexMetaData when inspecting shards (#50214)
- [ ] 972b81f8a9d Account trimAboveSeqNo in committed translog generation (#50205)
- [ ] 34f83904cc8 Adjust bwc for #48430
- [ ] b9fbc8dc748 Migrate peer recovery from translog to retention lease (#49448)
- [ ] 70af176dea3 Improve DateFieldMapper `ignore_malformed` handling (#50090)
- [ ] 1329acc094c Upgrade to lucene 8.4.0-snapshot-662c455. (#50016)
- [ ] fc3454b10bb Randomly run CCR tests with _source disabled (#49922)
- [ ] de5eb04f050 Silence lint warnings in server project - part 2 (#49728)
- [ ] 944c681680d Make Snapshot Metadata Javadocs Clearer (#49697)
- [ ] 3ad8aa6d465 Remove obsolete resolving logic from TRA (#49685)
- [ ] a354c607228 Revert "Remove obsolete resolving logic from TRA (#49647)"
- [ ] 6cca2b04fa0 Remove obsolete resolving logic from TRA (#49647)
- [ ] 4b16d50cd4b Fix typo when assigning null_value in GeoPointFieldMapper  (#49645)
- [ ] c2deb287f13 Add a cluster setting to disallow loading fielddata on _id field (#49166)
- [ ] 563b2736a9f Annotated text type should extend TextFieldType (#49555)
- [ ] 725dda37ea5 Flush instead of synced-flush inactive shards (#49126)
- [ ] b8ce07b4cc5 Pre-sort shards based on the max/min value of the primary sort field (#49092)
- [ ] 7754e626ce7 Use retention lease in peer recovery of closed indices (#48430)
- [ ] 4ac79f900dd Verify translog checksum before UUID check (#49394)
- [ ] 8e2a23aa0aa make dim files mmapped (#49272)
- [ ] 4d659c4bdbf Make Repository.getRepositoryData an Async API (#49299)
- [ ] 0f6ffc20a53 Refactor percolator's QueryAnalyzer to use QueryVisitors (#49238)
- [ ] c1c7fa5d9c8 Remove type field from internal PutMappingRequest (#48793)
- [ ] 66f49d8ea5d Always use primary term from primary to index docs on replica (#47583)
- [ ] 7559bab501f MapperService.merge() should take a single mapper rather than a map (#48954)
- [ ] 293648b4ee7 [#40366] Silence some lint warnings in server project (#48927)
- [x] 79625fe6940 Remove Uid as an instantiable class (#48801)
- [ ] 01030caf8e4 Allow realtime get to read from translog (#48843)
- [ ] d029e18c722 Closed shard should never open new engine (#47186)
- [ ] 3ce7a37f1ff Remove index.force_memory_term_dictionary setting (#48873)
- [ ] e0469a72199 Remove support for ancient corrupted markers (#48858)
- [ ] a5f17fc2750 Add preflight check to dynamic mapping updates (#48817)
- [ ] 6742d9c9d90 Cleanup Redundant Futures in Recovery Code (#48805)
- [ ] 4c75564bd13 Return consistent source in updates (#48707)
- [ ] 927cc34eca9 Do not warm up searcher in engine constructor (#48605)
- [ ] e58fc03d42f Restore from Individual Shard Snapshot Files in Parallel (#48110)
- [ ] dbd33f77643 Remove type parameter from MapperService.documentMapper() (#48593)
- [ ] 4b89171e6f1 Fix ref count handling in Engine.failEngine (#48639)
- [ ] 4e81ae74b2e Remove deprecated IndexMetaData.getMappings() method (#47344)
- [ ] 71a6873e892 Greedily advance safe commit on new global checkpoint (#48559)
- [ ] 5297e5afa0b Add a new merge policy that interleaves old and new segments on force merge (#48533)
- [ ] 379e8470488 Refresh should not acquire readLock (#48414)
- [ ] 2e7d62c27c9 Geo: improve handling of out of bounds points in linestrings (#47939)
- [ ] 54d6da54320 [Java.time] Calculate week of a year with ISO rules (#48209)
- [ ] 458de912561 Make BytesReference an interface (#48171)
- [ ] 6563c0fb7b2 Remove Redundant Version Param from Repository APIs (#48231)
- [ ] 602081f19cf [DOCS] Fix typos in InternalEngine.java comments (#46861)
- [ ] 704317da71c Remove Support for pre-5.x Indices in Restore (#48181)
- [x] 6531369f11d Don't persist type information to translog (#47229)
- [ ] d6d9fc5881c Don't apply the plugin's reader wrapper in can_match phase (#47816)
- [ ] e628f35f69b Sequence number based replica allocation (#46959)
- [ ] d8f5a3d647a Avoid unneeded refresh with concurrent realtime gets (#47895)
- [ ] 694373294fe Allow truncation of clean translog (#47866)
- [ ] 566e1b7d33e Remove type field from DocWriteRequest and associated Response objects (#47671)
- [ ] f749bacf34b Sync translog without lock before trim unreferenced readers (#47790)
- [ ] e3adedf610d Geo: implement proper handling of out of bounds geo points (#47734)
- [ ] f9cb29450ec Geo: Fixes indexing of linestrings that go around the globe (#47471)
- [ ] c26ce1d7f52 DocValueFormat implementation for date range fields (#47472)
- [ ] 8c464775663 Limit number of retaining translog files for peer recovery (#47414)
- [ ] 29463551aea Remove typename checks in mapping updates (#47347)
- [ ] 9993cf391f1 Use standard semantics for retried auto-id requests (#47311)
- [ ] 8585d58b767 Provide better error when updating geo_shape field mapper settings (#47281)
- [ ] c048c86351b Allow optype CREATE for append-only indexing operations (#47169)
- [ ] 237b238a769 Remove `type` query (#47207)
- [ ] ff99bc1d3f8 Remove per-type indexing stats (#47203)
- [ ] 2b8c7c5e11c Remove write lock for Translog.getGeneration (#47036)
- [ ] b1a03a137fd Remove unused private methods and fields (#47115)
- [x] 9df6cbef9e4 Remove isRecovering method from Engine (#47039)
- [ ] 65374c9c010 Tidy up Store#trimUnsafeCommits (#47062)
- [ ] b269a77ccf5 Remove ensureIndexHasHistoryUUID (#47043)
- [ ] b6454e978e1 Reject regexp queries on the _index field. (#46945)
- [ ] f11a3c22298 Track Shard Snapshot Generation in CS (#46864)
- [ ] 2351aa3efbd Disallow `_field_names` enabled setting (#46681)
- [ ] 127b8d03642 Add support for aliases in queries on _index. (#46640)
- [ ] 6a5bae184b8 Remove default mapping (#44945)
- [ ] 7c90801aff3 Remove types from Get/MultiGet (#46587)
- [ ] dffaefeed44 Remove Duplicate Shard Snapshot State Updates (#46862)
- [ ] ff9e8c62242 Remove ExceptionHelper.detailedMessage (#45878)
- [ ] b52c2d5d82a Handle lower retaining seqno retention lease error (#46420)
- [ ] 4ab71116688 Geo: fix indexing of west to east linestrings crossing the antimeridian (#46601)
- [ ] d0a7bbcb694 Deprecate `_field_names` disabling (#42854)
- [ ] 41d3eb31946 Revert "Sync translog without lock when trim unreferenced readers (#46203)"
- [ ] fd8183ee51d Sync translog without lock when trim unreferenced readers (#46203)
- [ ] cb2e7325992 Flush engine after big merge (#46066)
- [ ] a2d4b81b6b5 Handle delete document level failures (#46100)
- [ ] 32514665969 Handle no-op document level failures (#46083)
- [ ] 54ccdc7e9ad Do not create engine under IndexShard#mutex (#45263)
- [ ] 1a0dddf4ad2 Range Field support for Histogram and Date Histogram aggregations(#45395)
- [ ] 18282b0f2b0 Update translog checkpoint after marking ops as persisted (#45634)
- [ ] 9f654fd67ef Fsync translog without writeLock before rolling (#45765)
- [ ] 4d210dda02d Remove index-N Rebuild in Shard Snapshot Updates (#45740)
- [ ] b0d346fd742 Ignore translog retention policy if soft-deletes enabled (#45473)
- [ ] 8930f7fbf76 Remove support for string in unmapped_type. (#45675)
- [ ] abb30f0f814 Make sure to validate the type before attempting to merge a new mapping. (#45157)
- [ ] 13a8835e5a8 Geo: Change order of parameter in Geometries to lon, lat (#45332)
- [ ] 8d1ea865197 Set start of the week to Monday for root locale (#43652)
- [ ] fd4acb3e8b7 Only retain reasonable history for peer recoveries (#45208)
- [ ] 6bb6927151c Remove assertion after locally recover replica (#45181)
- [ ] 302d29c8705 Trim local translog in peer recovery (#44756)
- [ ] 01287eacb2f Use index for peer recovery instead of translog (#45136)
- [ ] 48d31194c25 Always use primary term of operation in InternalEngine (#45083)
- [ ] 0a6adceaa36 Use IndicesModule named writables in elasticsearch-shard tool (#45036)
- [ ] 192845be8df Cleanup Various Action- Listener and Runnable Usages (#42273)
- [ ] b07310022d2 [SPATIAL] New ShapeFieldMapper for indexing cartesian geometries (#44980)
- [ ] 7e627d27e5c Geo: move indexShape to AbstractGeometryFieldMapper.Indexer (#44979)
- [ ] 0b9b91a63c1 Remove leniency during replay translog in peer recovery (#44989)
- [ ] c9049cfca14 Remove leniency in reset engine from translog (#44711)
- [ ] 94b684630c8 [GEO] Refactor DeprecatedParameters in AbstractGeometryFieldMapper (#44923)
- [ ] 690136327fe Cleanup Deadcode o.e.indices (#44931)
- [ ] f603f06250a Geo: refactor geo mapper and query builder (#44884)
- [ ] 321c2b86270 Force Merge should reject requests with `only_expunge_deletes` and `max_num_segments` set (#44761)
- [ ] 7895dc99154 Convert Transport Request/Response to Writeable (#44636)
- [ ] fd54e3e8244 Remove support for old translog checkpoint formats (#44272)
- [ ] 22a30418649 Convert index and persistent actions/response to writeable (#44582)
- [ ] bbe97b03a55 remove usages of #readOptionalStreamable, #readStreamableList. (#44578)
- [ ] 06d89121f63 Remove type parameter from ParserContext (#44478)
- [ ] c8ae530e7a6 Don't use index_phrases on graph queries (#44340)
- [ ] 46c2d7224d6 Ensure field caps doesn't error on rank feature fields. (#44370)
- [ ] ca9ee218eb5 Ensure replication response/requests implement writeable (#44392)
- [ ] 33ad7928fbb Geo: extract dateline handling logic from ShapeBuilders (#44187)
- [ ] c251450a2fe Throw TranslogCorruptedException in more cases (#44217)
- [ ] cb3e0cbaa92 Fail engine if hit document failure on replicas (#43523)
- [ ] a85199286de Support WKT point conversion to geo_point type (#44107)
- [ ] be0df44b1ba Upgrade to lucene-8.2.0-snapshot-860e0be5378 (#44171)
- [ ] 23b8185fdc9 Convert ReplicationResponse to Writeable (#43953)
- [ ] b842ea8a8ae Some Cleanup in o.e.i.shard (#44097)
- [ ] d01d831a196 Removed writeTo from TransportResponse and ActionResponse (#44092)
- [ ] 688cf832fe1 Enable indexing optimization using sequence numbers on replicas (#43616)
- [ ] 819abe95233 Improve RetentionLease(Bgrd)SyncAction#toString() (#43987)
- [x] 399d53e5c03 Refactor index engines to manage readers instead of searchers (#43860)
- [ ] 00a5e5a42a3 Adapt version check after backport
- [ ] e28fb1f0658 Fix index_prefix sub field name on nested text fields (#43862)
- [ ] d87c9fdae44 Refresh translog stats after translog trimming in NoOpEngine (#43825)
- [ ] d1c6fb865dd Convert replication calls from action.execute to nodeclient (#43834)
- [ ] 3cc222ed1d3 Return reloaded analyzers in _reload_search_ananlyzer response (#43813)
- [ ] 217b875e760 Remove sort by primary term when reading soft-deletes (#43845)
- [ ] 03c2b27c191 Expose translog stats in ReadOnlyEngine (#43752)
- [ ] b76d3143feb AsyncIOProcessor preserve thread context (#43729)
- [ ] b33ffc1ae06 Rename Action to ActionType (#43778)
- [ ] e6444d3007f Add StreamableResponseAction to aid in deprecation of Streamable (#43770)
- [ ] c900795df87 Trim translog for closed indices (#43156)
- [x] fd4eb96d1c2 Refactor IndexSearcherWrapper to disallow the wrapping of IndexSearcher (#43645)
- [ ] f3317eb82d8 Add support for 'flattened object' fields. (#42541)
- [ ] 6f5b3a6c71f Do not use MockInternalEngine in GatewayIndexStateIT (#43716)
- [ ] 56ee1a5e007 Allow reloading of search time analyzers (#43313)
- [ ] 3a7ebb05d02 Avoid AssertionError when closing engine (#43638)
- [ ] a520a5d761b Add prefix intervals source (#43635)
- [ ] 1a7730160f0 Adjust bwc assertion after backporting #42201
- [ ] f83d8c26667 Ensure relocation target still tracked when start handoff (#42201)
- [ ] 0cfc9ff7759 Sync global checkpoint on pending in-sync shards (#43526)
- [ ] 5e668ad3984 Add additional logging for #43034
- [ ] 893c50f74f5 Assert that NOOPs must succeed (#43483)
- [ ] 70839bf3d64 Cleanup legacy logic in CombinedDeletionPolicy (#43484)
- [ ] 1ad8af127b1 Added parsing of erroneous field value (#42321)
- [ ] d7d5e2fd55b Adapt local checkpoint assertion
- [ ] f27e808c145 Advance checkpoints only after persisting ops (#43205)
- [ ] f47174f04a2 Do not use soft-deletes to resolve indexing strategy (#43336)
- [ ] 99495aa171a Replace Streamable w/ Writeable in SingleShardRequest and subclasses (#43222)
- [ ] bbc29bb0fd7 Rebuild version map when opening internal engine (#43202)
- [ ] fdacbaf7f84 Account soft deletes in committed segments (#43126)
- [ ] a00da6e9539 Allow big integers and decimals to be mapped dynamically. (#42827)
- [ ] 4de85c4d97b Only load FST off heap if we are actually using mmaps for the term dictionary (#43158)
- [ ] ef8f90cc2a5 Also mmap terms index (`.tip`) files for hybridfs (#43150)
- [x] 62620f28663 Remove usage of FileSwitchDirectory  (#42937)
- [x] 8159fdfcc9a Fix assertion in ReadOnlyEngine (#43010)

Below are patches deferred. In-between patches we applied or skipped are not
listed anymore.

- [d] 56a662ed288 Remove Support for VERSION_CHECKPOINTS Translogs (#42782)
- [d] 6e39433cd53 Remove "nodes/0" folder prefix from data path (#42489)
- [d] c459ea828f6 Remove node.max_local_storage_nodes (#42428)
- [d] 3af0c1746b3 Expose external refreshes through the stats API (#38643)
- [d] ef18d3fb5b2 Add analysis modes to restrict token filter use contexts (#36103)
- [d] 309a3e4ccbc Add support for replicating closed indices (#39499)
