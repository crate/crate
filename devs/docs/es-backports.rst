======================================
Backporting changes from Elasticsearch
======================================

With CrateDB 4.0.0, we integrated the Elasticsearch code and then pruned out
everything we don't use.

With CrateDB 4.2.0, we changed the module structure so that Elasticsearch and
CrateDB code is no longer split, but mixed within the same modules. The
majority is in the ``server`` component.

We still want to keep many of the components up-to-date, while other
components will converge more and more over time.

The areas where we want to stay close to upstream Elasticsearch are mostly:

- Engine
- Snapshotting
- Recovery
- Discovery and master election


Applied changesets
==================

Patches should be applied in order. A backport commit message should be
prefixed with ``bp:``. This allows us to verify later on whether a patch was
applied using something like this::

    sh$ git log --oneline --grep 'bp:'

If a patch is skipped, use the ``sp:`` prefix instead.

To see if there are new changes, you can use ``git log`` in the Elasticsearch
repository on the 7.10 branch. For example::

    git log --oneline 22ba759e1f3.. -- \
      server/src/main/java/org/elasticsearch/index/{engine,snapshots,store,translog,shard,seqno,mapper,codec}/ \
      server/src/main/java/org/elasticsearch/indices/recovery/ \
      server/src/main/java/org/elasticsearch/cluster/coordination \
      server/src/main/java/org/elasticsearch/cluster/routing \
      server/src/main/java/org/elasticsearch/transport \
      server/src/main/java/org/elasticsearch/gateway \
      server/src/main/java/org/elasticsearch/action/admin/cluster/health \
      server/src/main/java/org/elasticsearch/action/support/replication \
      server/src/main/java/org/elasticsearch/action/support/master \
      server/src/main/java/org/elasticsearch/snapshots \
      server/src/main/java/org/elasticsearch/repositories


Here ``4b16d50cd4b`` is the starting point, it shows any changes since then
that affected files in the given folder.

(Note that there may be changes before ``4b16d50cd4b`` that are missing.)

We should eventually bump the reference point once all patches have been
applied to a certain point.

Below lists the changesets that we applied. This should be updated whenever a
backport is made. If a patch is skipped because it is not applicable, it
should be crossed out as well.

- ``x`` to mark applied patches
- ``s`` for skipped patches if they are not applicable (for example, if the
  functionality is not present in CrateDB)
- ``sn`` for skipped patches which have no effect because the related sources
  do not exist anymore
- ``sa`` for skipped patches which have been applied already
- ``su`` for skipped patches which are unrelated to CrateDB
- ``d`` marks a delayed patch - a non-trivial change we should apply that
  does not affect too any components, so delaying it doesn't make applying
  other patches more difficult

- [ ] 20d2313d4b6 Ensure ReplicationOperation notify listener once (#68256)
- [ ] b8102b2e0f3 [DOCS] Fix response typo in transport message listener (#68125) (#68169)
- [ ] e9b798bdb15 [7.10] Make FilterAllocationDecider totally ignore tier-based allocation settings (#67019) (#67034)
- [x] 5000ec87caa Fix constructors of NoOpResult (#66269)
- [ ] 7e1fc6dc674 Adjust Cleanup Order of Internal State in SnapshotsService (#66225) (#66244)
- [ ] 8cbb9612d0f [7.10] Create AllocationDeciders in the main method of the ILM step (#65037) (8ac30f9a) (#66070)
- [ ] 16fae5d66d3 Also reroute after shard snapshot size fetch failure (#66008)
- [ ] 26d67c1662d Ensure notify when proxy connections disconnect (#65697)
- [ ] 745f527feac Deduplicate Index Meta Generations when Deserializing (#65619) (#65666)
- [x] 6bbeedc9321 Reset Deflater/Inflater after Use in DeflateCompressor (#65617) (#65646)
- [ ] 0137c1679bb Fix the earliest last modified age of translog stats (#64753)
- [ ] fb84b6710d5 Restore use of default search and search_quote analyzers (#65491) (#65562)
- [ ] 88993e763f9 Fix handling of null values in geo_point (#65307)
- [ ] feca22729cd [DOCS] Remove duplicated word in replica shard allocator comment (#65295) (#65317)
- [ ] caf143f4a51 Unused boost parameter should not throw mapping exception (#64999) (#65014)
- [ ] d173ba6b2d7 Fix NPE in toString of FailedShard (#64770) (#64779)
- [ ] 33f703ef1f8 Fix up roles after rolling upgrade (#64693)
- [s] 51e9d6f2275 Revert Serializing Outbound Transport Messages on IO Threads (#64632) (#64654)
- [ ] dad3b26560c Fix Typo in Repository Exception Message (#64412) (#64434)
- [ ] 2983584ef6e Fix #invariant Assertion in CacheFile (#64180) (#64264)
- [ ] a697d5edae1 Don't Generate an Index Setting History UUID unless it's Supported (#64164) (#64213)
- [ ] e02561476ea Fix Broken Clone Snapshot CS Update (#64116) (#64159)
- [ ] bdea16301d7 Fix testMasterFailoverDuringCloneStep1 (#63580) (#64127)
- [ ] 7ea44d20c3c Try to fix DiskThresholdDeciderIT (#63614) (#63721)
- [ ] 424b3137841 Adapt Shard Generation Assertion for 7.x (#63625) (#63642)
- [ ] 9015b50e1b8 Check docs limit before indexing on primary (#63273)
- [ ] f70391c6cca Fix Broken Snapshot State Machine in Corner Case (#63534) (#63608)
- [ ] 845ccc22646 [DOCS] Fix dup word in ShardRouting hashcode method. (#63452) (#63583)
- [ ] 8499924e51e InternalSnapshotsInfoService should also removed failed snapshot shard size infos (#63492) (#63592)
- [ ] 9e52513c7bf Add support for missing value fetchers. (#63585)
- [x] 56092b1a9fd Flush translog writer before adding new operation (#63505)
- [ ] ae2fc4118d2 Add factory methods for common value fetchers. (#63438)
- [ ] c6b915c8e67 Make TextFieldMapper.FAST_PHRASE_SUFFIX private.
- [ ] c4726a2cece Don't emit separate warnings for type filters (#63391)
- [ ] 244f1a60f92 Selectively Add ClusterState Listeners Depending on Node Roles (#63223) (#63396)
- [ ] eac99dd594a SnapshotShardSizeInfo should prefer default value when provided (#63390) (#63394)
- [x] dd4b0d85fe0 Write translog operation bytes to byte stream (#63298)
- [x] 64bbbaeef1a Do not block Translog add on file write (#63374)
- [ ] f17ca18dfa8 Make array value parsing flag more robust. (#63371)
- [ ] 87076c32e21 Determine shard size before allocating shards recovering from snapshots (#61906) (#63337)
- [ ] ca68298e89c Remove MapperService argument from IndexFieldData.Builder#build (#63197) (#63311)
- [ ] 7405af8060b Convert TypeFieldType to a constant field type (#63214)
- [ ] d7f6812d788 Improve Snapshot Abort Efficiency (#62173) (#63297)
- [ ] 25fbc014598 Retry CCR shard follow task when no seed node left (#63225)
- [ ] 5c3a4c13ddd Clone Snapshot API (#61839) (#63291)
- [ ] e91936512aa Refactor SnapshotsInProgress State Transitions (#60517) (#63266)
- [ ] 860791260df Implement Shard Snapshot Clone Logic (#62771) (#63260)
- [ ] cf75abb021f Optimize XContentParserUtils.ensureExpectedToken (#62691) (#63253)
- [ ] 51d0ed1bf30 Prepare Snapshot Shard State Update Logic For Clone Logic (#62617) (#63255)
- [ ] 89de9fdcf77 Cleanup Blobstore Repository Metadata Serialization (#62727) (#63249)
- [ ] d13c1f50581 Fix Overly Strict Assertion in BlobStoreRepository (#63061) (#63236)
- [ ] b4a1199e871 Uniquely associate term with update task during election (#62212)
- [ ] c9baadd19bf Fix to actually throttle indexing when throttling is activated (#61768)
- [ ] ba5574935e2 Remove dependency of Geometry queries with mapped type names (#63077) (#63110)
- [ ] 8c6e197f510 Remove allocation id from engine (#62680)
- [ ] e28750b001e Add parameter update and conflict tests to MapperTestCase (#62828) (#62902)
- [ ] 862fab06d3a Share same existsQuery impl throughout mappers (#57607)
- [ ] 5ca86d541c5 Move stored flag from TextSearchInfo to MappedFieldType (#62717) (#62770)
- [ ] cb1dc5260fb Dedicated threadpool for system index writes (#62792)
- [ ] 3f856d1c81a Prioritise recovery of system index shards (#62640)
- [ ] a0df0fb074b Search - add case insensitive flag for "term" family of queries #61596 (#62661)
- [ ] 0d5250c99b1 Add Trace Logging to File Restore (#62755) (#62761)
- [ ] 13e28b85ff5 Speed up RepositoryData Serialization (#62684) (#62703)
- [ ] 803f78ef055 Add field type for version strings (#59773) (#62692)
- [ ] 9a77f41e554 Fix cluster health when closing (#61709)
- [ ] 6a298970fdd [7.x] Allow metadata fields in the _source (#62616)
- [ ] 17aabaed155 Fix warning on boost docs and warning message on non-implementing fieldmappers
- [ ] 43ace5f80d7 Emit deprecation warnings when boosts are defined in mappings (#62623)
- [ ] 9f5e95505bf Also abort ongoing file restores when snapshot restore is aborted (#62441) (#62607)
- [ ] 06d5d360f92 Tidy up fillInStackTrace implementations (#62555)
- [ ] 9bb7ce0b229 [7.x] Allocate new indices on "hot" or "content" tier depending on data stream inclusion (#62338) (#62557)
- [ ] 91e23305295 Warn on badly-formed null values for date and IP field mappers (#62487)
- [ ] e0a4a94985f Speed up merging when source is disabled. (#62443) (#62474)
- [ ] 62dcc5b1ae1 Suppress stack in VersionConflictEngineException (#62433)
- [ ] 5112c173194 Add WARN Logging on Slow Transport Message Handling (#62444) (#62521)
- [ ] 14aec44cd86 Log if recovery affected by disconnect (#62437)
- [ ] 24a24d050ab Implement fields fetch for runtime fields (backport of #61995) (#62416)
- [ ] ffbc64bd109 Log WARN on Response Deserialization Failure (#62368) (#62388)
- [ ] 95766da3452 Save Some Allocations when Working with ClusterState (#62060) (#62303)
- [ ] 875af1c976f Remove Dead Variable in BlobStoreIndexShardSnapshots. (#62285) (#62295)
- [ ] 808c8689ac9 Always include the matching node when resolving point in time  (#61658)
- [ ] 3fc35aa76e6 Shard Search Scroll failures consistency (#62061)
- [ ] 4d528e91a12 Ensure validation of the reader context is executed first (#61831)
- [ ] 3d69b5c41e2 Introduce point in time APIs in x-pack basic (#61062)
- [ ] 7b941a18e9d Optimize Snapshot Shard Status Update Handling (#62070) (#62219)
- [ ] 6710104673d Fix Creating NOOP Tasks on SNAPSHOT Pool (#62152) (#62157)
- [x] ed4984a32e7 Remove Redundant Stream Wrapping from Compression (#62017) (#62132)
- [x] 075271758e3 Keep checkpoint file channel open across fsyncs (#61744)
- [ ] 2bb5716b3dc Add repositories metering API (#62088)
- [ ] bb0a583990e Allow enabling soft-deletes on restore from snapshot (#62018)
- [ ] 3389d5ccb25 Introduce integ tests for high disk watermark (#60460)
- [ ] 395538f5083 Improve Snapshot State Machine Performance (#62000) (#62049)
- [s] a295b0aa86f Fix null_value parsing for data_nanos field mapper (#61994)
- [s] 1799c0c5833 Convert completion, binary, boolean tests to MapperTestCase (#62004)
- [s] 0c8b4385777 Add support for runtime fields (#61776)
- [ ] b26584dff89 Remove unused deciders in BalancedShardsAllocator (#62026)
- [s] 6d08b55d4e3 Simplify searchable snapshot shard allocation (#61911)
- [s] 66bb1eea982 Improve error messages on bad [format] and [null_value] params for date mapper (#61932)
- [s] 31c026f25cc upgrade to Lucene-8.7.0-snapshot-61ea26a (#61957) (#61974)
- [s] af01ccee93e Add specific test for serializing all mapping parameter values (#61844) (#61877)
- [s] d59343b4ba8 Allow [null] values in [null_value] (#61798) (#61807)
- [ ] 3fd25bfa877 Fix Concurrent Snapshot Create+Delete + Delete Index (#61770) (#61773)
- [s] 5723b928d7d Remove Outdated Snapshot Docs (#61684) (#61728)
- [s] 1bfebd54ea7 [7.x] Allocate newly created indices on data_hot tier nodes (#61342) (#61650)
- [s] f769821bc80 Pass SearchLookup supplier through to fielddataBuilder (#61430) (#61638)
- [x] b866aaf81c0 Use int for number of parts in blob store (#61618)
- [s] 9f566644af2 Do not create two loggers for DeprecationLogger backport(#58435)  (#61530)
- [s] 8b56441d2b0 Search - add case insensitive support for regex queries. (#59441) (#61532)
- [s] f3f7d25316f Header warning logging refactoring backport(#55941) (#61515)
- [x] f22ddf822e2 Some Optimizations around BytesArray (#61183) (#61511)
- [x] 806dfcfcf7d Speed up Compression Logic by Pooling Resources (#61358) (#61495)
- [s] f3b6d49ae1e Migrate server mapper tests to new MapperTestCase (#61378) (#61490)
- [s] 078e8717eea Stop opening PING conns to remote clusters (#61408)
- [s] 997c73ec177 Correct how field retrieval handles multifields and copy_to. (#61391)
- [x] 08dbd6d9893 Optimize a few Spots on IO Loop (#60865) (#61380)
- [s] b1aa0d8731e Fix fieldnames field type for pre-6.1 indexes (#61322)
- [x] 98213df9462 Report more details of unobtainable ShardLock (#61255)
- [x] b21cb7f4666 Reduce allocations when persisting cluster state (#61159)
- [x] c6276ae1771 Fail invalid incremental cluster state writes (#61030)
- [s] 25404cbe3d0 Provide option to allow writes when master is down (#60605)
- [x] 6644f2283d2 Do not access snapshot repo on dedicated voting-only master node (#61016)
- [x] af519be9cbd Ensure repo not in use for wildcard repo deletes (#60947)
- [x] 32423a486d6 Simplify and Speed up some Compression Usage (#60953) (#61008)
- [s] 2fa6448a15b System index reads in separate threadpool (#60927)
- [s] a93be8d5771 Handle nested arrays in field retrieval. (#60981)
- [s] 3e2dfc6eac0 Remove GCS Bucket Exists Check (#60899) (#60914)
- [s] 0286d0a769e Move distance_feature query building into MFT (#60614) (#60846)
- [s] f44c28b5951 Deprecate and ignore join timeout (#60872)
- [x] 1f49e0b9d01 Fix testRerouteOccursOnDiskPassingHighWatermark (#60869)
- [x] 2f76c48ea71 Propagate forceExecution when acquiring permit (#60634)
- [s] b4044004aa4 Add recovery state tracking for Searchable Snapshots (#60751)
- [x] ebfb93ff264 Improve some BytesStreamOutput Usage (#60730) (#60736)
- [s] 9f6f66f1567 Fail searchable snapshot shards on invalid license (#60722)
- [s] b3ae5d26bd1 Move mapper validation to the mappers themselves (#60072) (#60649)
- [x] 212ce22d155 Optimize CS Persistence Stream Use (#60643) (#60647)
- [x] 3409e019d23 Ignore shutdown when retrying recoveries (#60586)
- [s] 2cde43b799d Allows nanosecond resolution in search_after (backport of #60328) (#60426)
- [x] d2ddf8cd6a1 Improve deserialization failure logging (#60577)
- [x] 3270cb3088c More Efficient Writes for Snapshot Shard Generations (#60458) (#60575)
- [s] 204efe9387c Add Repository Setting to Disable Writing index.latest (#60448) (#60576)
- [s] 8ac81a3447d Remove IndexFieldData#clear since it is unused. (#60475)
- [x] a2c49a4f02d Reduce Heap Use during Shard Snapshot (#60370) (#60440)
- [ ] 8429b4ace88 Fix Queued Snapshot Deletes After Finalization Failure (#60285) (#60379)
- [s] 1f6a3765e46 Fix NPE in SnapshotsInProgress Constructor (#60355)
- [x] 753fd4f6bc3 Cleanup and optimize More Serialization Spots (#59959) (#60331)
- [s] c7bfb5de41b Add search `fields` parameter to support high-level field retrieval. (#60258)
- [x] 9450ea08b4d Log and track open/close of transport connections (#60297)
- [x] d39622e17ec Stop Serializing RepositoryData Twice when Writing (#60107) (#60269)
- [x] a55c869aab3 Properly document keepalive and other tcp options (#60216)
- [x] cb4c21fa7bd [DOCS] Fix typo in adapt auto expand replica comments (#60187) (#60239)
- [x] bf7e53a91e1 Remove node-level canAllocate override (#59389)
- [x] ebb66778158 Formalize and Streamline Buffer Sizes used by Repositories (#59771) (#60051)
- [ ] c06c9fb9666 Fix BwC Snapshot INIT Path (#60006)
- [s] a0ad1a196b2 Wrap up building parametrized TypeParsers (#59977)
- [s] 19fe3e511fc Deprecate camel case date format backport(#59555) (#59948)
- [x] e37bfe8a5f0 Stop Checking if Segment Data Blob Exists before Write (#59905) (#59971)
- [x] cefaa17c52c Simplify CheckSumBlobStoreFormat and make it more Reusable (#59888) (#59950)
- [x] 5b92596fad5 Cleanup and Optimize Multiple Serialization Spots (#59626) (#59936)
- [s] 8647872a1e5 Simplify structure for parsing points. (#59938)
- [x] 65f6fb8e94f Shortcut mapping update if the incoming mapping version is the same as the current mapping version (#59517) (#59772)
- [s] 343053c0a7f Fix compilation in Eclipse (backport #59675)
- [s] 27067de6991 Make MappedFieldType#meta final (#59383)
- [x] b599f7a9c07 Fix estimate size of translog operations (#59206)
- [s] 2b70758a052 Correct type parametrization in geo mappers. (#59583)
- [x] cc7093645cc Cleanup some Serialization Code around Snapshots (#59532) (#59606)
- [x] b8d73a1e7ee Default gateway.auto_import_dangling_indices to false (#59302)
- [s] 691759fb1fc Validate snapshot UUID during restore (#59601)
- [ ] 2dd086445c3 Enable Fully Concurrent Snapshot Operations (#56911) (#59578)
- [x] 06d94cbb2ac Fix TODO about Spurious FAILED Snapshots (#58994) (#59576)
- [x] e1014038e90 Simplify Repository.finalizeSnapshot Signature (#58834) (#59574)
- [x] 16a47e0d089 Simplify SnapshotsInProgress Construction (#58893) (#59573)
- [x] 68a199f75fe Minor Cleanup Dead Code Snapshotting (#57716) (#59569)
- [x] d456f7870a7 Deduplicate Index Metadata in BlobStore (#50278) (#59514)
- [s] 408a07f96a6 Separate coordinating and primary bytes in stats (#59487)
- [s] 1a24916fef8 Enable replication retries on 7.9+ (#59546)
- [x] 0e3d87ab54b Add Assertions on CS Application in Snapshot Logic (#58681) (#59511)
- [x] 81e96954d01 Improve Efficiency of SnapshotsService CS Apply (#56874) (#59508)
- [s] 623df95a323 Adding indexing pressure stats to node stats API (#59467)
- [s] 68d56fa7dba Implement rejections in `WriteMemoryLimits` (#59451)
- [s] eb0b28dd1d6 Move getPointReaderOrNull into AggregatorBase (#58769) (#59455)
- [x] 64c5f70a2d4 Remove Needless Context Switches on Loading RepositoryData (#56935) (#59452)
- [x] bde92fc5fcc Remove Needless Context Switch From Snapshot Finalization (#56871) (#59443)
- [x] 31be3a36452 More Efficient Snapshot State Handling (#56669) (#59430)
- [s] b1b7bf39122 Make data streams a basic licensed feature. (#59392)
- [s] bd01fd107ce Revert "Migrate CompletionFieldMapper to parametrized format (#59291)"
- [x] 4e574a7136c Remove Dead Code from Closed Index Snapshot Logic (#56764) (#59398)
- [s] 19ba6c39d27 Migrate CompletionFieldMapper to parametrized format (#59291)
- [x] 08b54feaaf2 Remove Snapshot INIT Step (#55918) (#59374)
- [s] c810a4a12e8 Continue to accept unused 'universal' params in <8.0 indexes (#59381)
- [x] 483386136d9 Move all Snapshot Master Node Steps to SnapshotsService (#56365) (#59373)
- [x] f4caadd239f MappedFieldType no longer requires equals/hashCode/clone (#59212)
- [x] d56fc72ee5b Fix node health-check-related test failures (#59277)
- [s] 67a27e2b9d4 Add declarative parameters to FieldMappers (#58663)
- [x] 6a0f7411e25 Do not release safe commit with CancellableThreads (#59182)
- [s] 17bd5592537 Fix the timestamp field of a data stream to @timestamp (#59210)
- [x] 9268b257895 Add Check for Metadata Existence in BlobStoreRepository (#59141) (#59216)
- [x] ef5c397c0f6 Sending operations concurrently in peer recovery (#58018)
- [x] de6ac6aea6d Fix recovery stage transition with sync_id (#57754)
- [x] 46c8d00852d Remove nodes with read-only filesystems (#52680) (#59138)
- [x] 1ced3f0eb38 Extract recovery files details to its own class (#59121)
- [x] 0752a86fe58 Enforce higher priority for RepositoriesService ClusterStateApplier (#59040)
- [x] 00ed31d000f Remove IndexShardRoutingTable#primaryAsList (#59044)
- [s] f0dd9b4ace6 Add data stream timestamp validation via metadata field mapper (#59002)
- [s] c1781bc7e7a [7.x] Add include_data_streams flag for authorization (#59008)
- [s] d22dd437f18 Fix Two Common Zero Len Array Instantiations (#58944) (#58993)
- [d] dc9e364ff2d Count coordinating and primary bytes as write bytes (#58984)
- [s] 1ef2cd7f1ad Add memory tracking to queued write operations (#58957)
- [x] be804b765d8 Avoid flipping translog header version (#58866)
- [s] d516959774c Re-enable support for array-valued geo_shape fields. (#58786) (#58943)
- [s] 0cd1dc31433 Percolator keyword fields should not store norms (#58899)
- [s] 5e49ee800ec Drop rewriting in date_histogram (backport of #57836) (#58875)
- [s] 3ba16e0f39e Move MappedFieldType#getSearchAnalyzer and #getSearchQuoteAnalyzer to TextSearchInfo (#58830)
- [s] 2c275913b97 [7.x] Week based parsing for ingest date processor (#58597) (#58802)
- [x] 15c85b29fd9 Account for recovery throttling when restoring snapshot (#58658) (#58811)
- [x] 3a234d26691 Account for remaining recovery in disk allocator (#58800)
- [s] ab65a57d700 Merge mappings for composable index templates (#58709)
- [x] b52a7641439 Fix NPE in SnapshotService CS Application (#58680) (#58735)
- [s] 95d85f29f80 Fix Snapshots Capturing Incomplete Datastreams (#58630) (#58656)
- [s] 4f2f257b12c Fix DataStream Handling on Restore of Global Metadata (#58631) (#58649)
- [x] 090211f7680 Fix Incorrect Snapshot Shar Status for DONE Shards in Running Snapshots (#58390) (#58593)
- [x] eaa60b7c54e [Docs] Fix return tuple element order (#58463)
- [x] 468e559ff7d Fix Memory Leak From Master Failover During Snapshot (#58511) (#58560)
- [s] 52ad5842a95 Introduce node.roles setting (#58512)
- [x] 9e4c5d1dded Cleaner Handling of Snapshot Related null Custom Values in CS (#58382) (#58501)
- [s] d5ac3bb87f7 Field capabilities - make `keyword` a family of field types (#58315) (#58483)
- [s] d251a482e9a Move MappedFieldType.similarity() to TextSearchInfo (#58439)
- [x] affc3954e6d [DOCS] Fix typo in RoutingNode comment (#58079) (#58454)
- [s] 8ebd341710e Add text search information to MappedFieldType (#58230) (#58432)
- [s] 943efb78fd7 Save Shard ID Serializations in Bulk Requests (#56209) (#58414)
- [x] 256b660f0a0 Remove anonymous PublicationContext implementation (#58412)
- [x] 519d1278e23 Make FieldTypeLookup immutable (#58162) (#58411)
- [s] a44dad9fbb4 [7.x] Add support for snapshot and restore to data streams (#57675) (#58371)
- [s] 4b8cf2af6a8 Add serialization test for FieldMappers when include_defaults=true (#58235) (#58328)
- [x] ca2d12d039b Remove Settings parameter from FieldMapper base class (#58237)
- [x] 2074412d79f Retry failed replication due to transient errors (#56230)
- [s] 5ddea03de77 Remove needless termsQuery implementation from StringFieldType (#57609)
- [x] b6585f2b513 Add new extensions for Lucene86 points codec to FsDirectoryFactory (#58226) (#58233)
- [x] 85be78b6249 Fix Snapshot Abort Not Waiting for Data Nodes (#58214) (#58228)
- [s] 03369e09805 Implement dangling indices API (#58176)
- [s] c6acc7c976f Correctly deal with aliases when retrieving lucene FieldType
- [s] 12a3f6dfca2 MappedFieldType should not extend FieldType (#58160)
- [x] a5bc5ae030b Don't log on RetentionLeaseSync error handler (#58157)
- [x] 1a48983a562 Fix Running TranslogOps on CS Thread (#58056) (#58076)
- [s] 8bd0147ba79 Correct how meta-field is defined for pre 7.8 hits (#57951)
- [x] f950c121bb6 Hide AlreadyClosedException on IndexCommit release (#57986)
- [s] 16e230dcb85 Update to lucene snapshot e7c625430ed (#57981)
- [s] 80f221e920d Use clean thread context for transport and applier service (#57792) (#57914)
- [x] fe85bdbe6f6 Fix Remote Recovery Being Retried for Removed Nodes (#57608) (#57913)
- [x] d5794204525 Stop Serializing Exceptions in SnapshotInfo (#57866) (#57898)
- [s] 9eec819c5b1 Revert "Use clean thread context for transport and applier service (#57792)"
- [s] 8199956937d Revert "Assert on request headers only (#57792)"
- [x] 8119b965178 Fix stalled send translog ops request (#57859)
- [x] c17121428ee Fix translog ops action name in channel listener (#57854)
- [s] b5d3565214d Assert on request headers only (#57792)
- [s] 259be236cfa Use clean thread context for transport and applier service (#57792)
- [x] 952cf770ed6 Reestablish peer recovery after network errors (#57827)
- [x] 0987c0a5f3d Fix Broken Numeric Shard Generations in RepositoryData (#57813) (#57821)
- [s] 70e63a365a6 Refactor how to determine if a field is metafield (#57378) (#57771)
- [s] 004eb8bd7e4 Fix Bug With RepositoryData Caching (#57785) (#57800)
- [s] 5a4e5a1e9d3 Handle `cluster.max_shards_per_node` in YAML config (#57234)
- [s] 80d1b12fa3e Restore ThreadContext after Serializing OutboundMessage (#57659) (#57681)
- [x] fc4dd6d6813 Timeout health API on busy master (#57587)
- [s] e0a15e8dc4a Remove the 'array value parser' marker interface. (#57571) (#57622)
- [s] e50f5140921 IndexFieldData should hold the ValuesSourceType (#57373) (#57532)
- [s] ba2d70d8eb6 Serialize Outbound Messages on IO Threads (#56961) (#57080)
- [x] 9bc9d01b841 Do not Block Snapshot Thread Pool Fully During Restore or Snapshot (#57360) (#57511)
- [s] 7aad4f6470f Store parsed mapping settings in IndexSettings (#57492)
- [x] 59570eaa7db Fix Local Translog Recovery not Updating Safe Commit in Edge Case (#57350) (#57380)
- [x] e4fd78f866c Remove Overly Strict Safety Mechnism in Shard Snapshot Logic (#57227) (#57362)
- [s] 04ef39da778 Change cluster info actions to be able to resolve data streams. (#57343)
- [s] 75868ea915d Catch InputCoercionException thrown by Jackson parser (#57287) (#57330)
- [s] 10e1dc199dc Revert "Remove unused logic from FieldNamesFieldMapper. (#56834)"
- [s] 5b08eaf90cb Fix trimUnsafeCommits for indices created before 6.2 (#57187)
- [x] d6b79bcd95e Remove Mapper.updateFieldType() (#57151)
- [s] 343fb699a4c Remove unused logic from FieldNamesFieldMapper. (#56834)
- [x] dde75b0f64e Fix Confusing Exception on Shard Snapshot Abort (#57116) (#57117)
- [x] 5569137ae3c Flatten ReleaseableBytesReference Object Trees (#57092) (#57109)
- [x] 9fa60f7367b Add History UUID Index Setting (#56930) (#57104)
- [x] d8165a3439b Turn off translog retention only when shard started (#57063)
- [x] 1dabdd9a201 Close channel on handshake error with old version (#56989) (#57025)
- [s] 99f7115f228 Revert "Close channel on handshake error with old version (#56989)"
- [s] c81a189da95 Close channel on handshake error with old version (#56989)
- [s] fb000d6cf4e Simplify range query methods for range types. (#56976)
- [x] 18bfbeda297 Move merge compatibility logic from MappedFieldType to FieldMapper (#56915)
- [x] 46e5c37267c Remove Dead Conditional from RoutingTable (#56870) (#56914)
- [x] 31f54c934e3 Relax Assertion About SnapshotsService Listeners (#56608) (#56863)
- [s] 195a5247d4b Prevent connection races in testEnsureWeReconnect (#56654)
- [s] a3e845cbad5 Suppress cluster UUID logs in 6.8/7.x upgrade (#56835)
- [s] d33d13f2bee Simplify generics on Mapper.Builder (#56747)
- [s] b718193a013 Clean up DocValuesIndexFieldData (#56372) (#56684)
- [s] 566b23c42ce Cancel task and descendants on channel disconnects (#56620)
- [s] 1ad83c37c4e Use index sort range query when possible. (#56710)
- [x] b4521d5183f upgrade to Lucene 8.6.0 snapshot (#56661)
- [x] 0a879b95d1d Save Bounds Checks in BytesReference (#56577) (#56621)
- [s] 9b64149ad22 [Geo] Refactor Point Field Mappers (#56060) (#56540)
- [x] 8e96e5c936a Use CollectionUtils.isEmpty where appropriate (#55910)
- [s] 9ae09570d87 Allow a number of broadcast transport actions to resolve data streams (#55726) (#56502)
- [s] 83739b5806e Backport: allow cluster health api to resolve data streams (#56425)
- [x] 8e9b69bfd79 Use snapshot information to build searchable snapshot store MetadataSnapshot (#56289) (#56403)
- [x] 085ff8c404c Add More Trace Logging to BlobStoreRepository (#56336) (#56401)
- [s] b84d1e2577b Improve logging around SniffConnectionStrategy (#56378)
- [x] 3bad5b3c01a Fix Noisy Logging during Snapshot Delete (#56264) (#56329)
- [s] e852bb29b76 Simplify signature of FieldMapper#parseCreateField. (#56144)
- [x] b9636713b1f Searchable Snapshots should respect max_restore_bytes_per_sec (#55952) (#56199)
- [x] 60d097e2626 Avoid copying file chunks in peer covery (#56072) (#56172)
- [s] 2ac32db6076 Move includeDataStream flag from IndicesOptions to IndexNameExpressionResolver.Context (#56151)
- [s] 6b5cf1b0318 For constant_keyword, make sure exists query handles missing values. (#55757)
- [x] e8ef44ce78a Allow Bulk Snapshot Deletes to Abort (#56009) (#56111)
- [x] e01b999ef03 Add Functionality to Consistently Read RepositoryData For CS Updates (#55773) (#56091)
- [x] 3a64ecb6bfe Allow Deleting Multiple Snapshots at Once (#55474) (#56083)
- [x] 69f50fe79f9 Improve same-shard allocation explanations (#56010)
- [s] 54dbea6c65c Improve RemoteConnectionManager consistency (#55759)
- [x] a508d3303d5 Ensure no circular reference in translog tragic exception (#55959)
- [x] 9eb67365002 Fix NullPointer when message shortcircuited (#55945)
- [x] 06b33457878 Avoid double-recovery when state recovery delayed
- [x] cd228095dfe Retry failed peer recovery due to transient errors (#55883)
- [x] cab7bcc1562 Disk decider respect watermarks for single data node (#55805) (#55847)
- [x] f38385ee257 Fix Leaking Listener When Closing NodeClient (#55676) (#55864)
- [x] 80662f31a1c Introduce mechanism to stub request handling (#55832)
- [s] 4bfd65a3750 Remove TODO around aggregating on _index.
- [x] b5916ac455c Ignore closed exception on refresh pending location listener (#55799)
- [x] fe9904fbea7 More Efficient Blobstore Metdata IO (#55777) (#55788)
- [x] 4403b690485 Fix NPE in Partial Snapshot Without Global State (#55776) (#55783)
- [x] 1a3f9e5a07c Return true for can_match on idle search shards (#55428)
- [s] b0e8a8a4d12 [Backport] Refactor Spatial Field Mappers (#55696)
- [x] dc899781f23 Fix Broken ExistingStoreRecoverySource Deserialization (#55657) (#55665)
- [x] d66af46724c Always use deprecateAndMaybeLog for deprecation warnings (#55319)
- [s] 08444555058 Add geo_shape mapper supporting doc-values in Spatial Plugin (#55037) (#55500)
- [x] db7eb8e8fff Remove Redundant CS Update on Snapshot Finalization (#55276) (#55528)
- [x] be60d504520 Allow searching of snapshot taken while indexing (#55511)
- [s] 3cc4e0dd09b Retry follow task when remote connection queue full (#55314)
- [x] 9e3b813b629 Ensure not to open directory reader on transport thread (#55419)
- [x] a0763d958d1 Make RepositoryData Less Memory Heavy (#55293) (#55468)
- [x] 4d543a569fa Add Snapshot Resiliency Test for Master Failover during Delete (#54866) (#55456)
- [x] 258f4b3be3c Fix Incorrect Concurrent SnapshotException on Master Failover (#54877) (#55448)
- [x] 60b8a5dabab Exclude Snapshot Shard Status Update Requests from Circuit Breaker (#55376) (#55383)
- [s] 417d5f20099 Make data streams in APIs resolvable. (#55337)
- [s] 22c55180c11 [7.x] Backport ValuesSourceRegistry and related work (#54922)
- [s] d7cded8d7a5 Fix updating include_in_parent/include_in_root of nested field. (#55326)
- [x] 7941f4a47e4 Add RepositoriesService to createComponents() args (#54814)
- [x] 8a565c4fa61 Voting config exclusions should work with absent nodes (#55291)
- [x] 2f91e2aab78 Fix Race in Snapshot Abort (#54873) (#55233)
- [x] d8b43c62838 Make Snapshot Deletes Less Racy (#54765) (#55226)
- [x] 156e5aa77f0 Fix testKeepTranslogAfterGlobalCheckpoint (#55868)
- [x] e164c9aaee5 Remove Redundant Cluster State during Snapshot INIT + Master Failover (#54420) (#55208)
- [x] 48048646e79 Move Snapshot Status Related Method to Appropriate Places (#54558) (#55209)
- [s] a610513ec76 Provide repository-level stats for searchable snapshots (#55051)
- [s] 52bebec51f6 NodeInfo response should use a collection rather than fields (#54460) (#55132)
- [s] 98fba920226 Fail sniff  process if no connections opened (#54934)
- [x] 65713743c2a Update translog policy before the next safe commit (#54839)
- [x] 619028c33e0 Implement transport circuit breaking in aggregator (#54927)
- [s] 475b210eec4 Improve guidance on removing default mappings. (#54915)
- [x] c7053ef824f Use TransportChannel in TransportHandshaker (#54921)
- [x] 9cf2406cf14 Move network stats marking into InboundPipeline (#54908)
- [x] 4d36917e526  Merge feature/searchable-snapshots branch into 7.x (#54803)  (#54825)
- [s] 2fdbed7797a Broadcast cancellation to only nodes have outstanding child tasks (#54312)
- [s] 5fb76022276 Disallow changing 'enabled' on the root mapper. (#54681)
- [x] 6d976e14684 Resolve some coordination-layer TODOs (#54511)
- [x] 5e3b6ab82b8 Use VotingConfiguration#of where possible (#54507)
- [x] 63e5f2b765f Rename META_DATA to METADATA
- [sa] 5fcda57b37f Rename MetaData to Metadata in all of the places (#54519)
- [s] c9db2de41da [7.x] Comprehensively test supported/unsupported field type:agg combinations (#54451)
- [s] c38e125425e Remove Redundant Documentation on SnapshotsService (#54482) (#54505)
- [x] 915435bbe48 Fix issue with pipeline releasing bytes early (#54474)
- [x] 9392fca36a0 Improve Snapshot Abort Behavior (#54256) (#54410)
- [x] 2ccddbfa88e Move transport decoding and aggregation to server (#54360)
- [x] 14b5daad7c9 Fix Snapshot Completion Listener Lost on Master Failover (#54286) (#54330)
- [x] 0d30b48613a Disallow negative TimeValues (#53913)
- [s] 3b4751bdb72 Avoid I/O operations when rewriting shard search request (#54044) (#54139)
- [s] 381d7586e40 Introduce formal role for remote cluster client (#54138)
- [s] b21b7fb09b7 Allow proxy mode server name to be updated (#54107)
- [s] 6a60f85bba1 Wildcard field - add normalizer support (#53851) (#54109)
- [s] e006d1f6cfc Use special XContent registry for node tool (#54050)
- [s] caefa78513d Align remote info api with new settings (#54102)
- [s] 1c1730facd4 Mask wildcard query special characters on keyword queries (#53127) (#53512)
- [s] d3cc5bff17d Give helpful message on remote connections disabled (#53690)
- [s] 960d1fb578d Revert "Introduce system index APIs for Kibana (#53035)" (#53992)
- [x] 5b9864db2c3 Better Incrementality for Snapshots of Unchanged Shards (#52182) (#53984)
- [s] efd18382066 Handle properly indexing rectangles that crosses the dateline (#53810) (#53947)
- [x] 879e26ec067 Describe STALE_STATE_CONFIG in ClusterFormationFH (#53878)
- [s] adfeb50a534 Use consistent threadpools in CoordinatorTests (#53868)
- [s] 4e6bbf6e3c5 Execute retention lease syncs under system context (#53838)
- [s] 7d3ac4f57d3 Revert "Apply cluster states in system context (#53785)"
- [s] 4178c57410f Apply cluster states in system context (#53785)
- [s] 4f1b2fd2b15 Add support for distance queries on geo_shape queries (#53466) (#53795)
- [s] b0884baf466 Geo shape query vs geo point backport (#53774)
- [x] 1615c4b3790 Fix testKeepTranslogAfterGlobalCheckpoint (#53704)
- [s] 9b3b08318d3 Remove unused import
- [s] bc5dae2713b Fix compilation in RoutingNode
- [x] 90ab949415e Improve performance of shards limits decider (#53577)
- [s] 6cc564d677a Restore off-heap loading for term dictionary in ReadOnlyEngine (#53713)
- [x] e7ae9ae596e Deprecate delaying state recovery for master nodes (#53646)
- [s] 71b703edd1e Rename AtomicFieldData to LeafFieldData (#53554)
- [x] 01d2339883d Invoke response handler on failure to send (#53631)
- [s] 881d0bfa8a8 Add server name to remote info API (#53634)
- [s] a906f8a0e4a Highlighters skip ignored keyword values (#53408) (#53604)
- [sa] 66374b61ca7 Remove extra code in allocation commands parsing (#53579)
- [s] b6c94fd73e8 Fix Term Vectors with artificial docs and keyword fields (#53504) (#53550)
- [s] 2438b899eb0 Support joda style date patterns in 7.x (#52555)
- [s] 9ada5083479 Fix date_nanos in composite aggs (backport of #53315) (#53347)
- [x] ac721938c22 Allow joining node to trigger term bump (#53338)
- [x] 7189c57b6cb Record Force Merges in Live Commit Data (#52694) (#53372)
- [x] 24f114766fb Fix doc_stats and segment_stats of ReadOnlyEngine (#53345)
- [s] 5c861cfe6e2 Upgrade to final lucene 8.5.0 snapshot (#53293)
- [x] 5e96d3e59ae Use given executor for global checkpoint listener (#53260)
- [s] c5738ae312a Notify refresh listeners on the calling thread (#53259)
- [s] f68917160e8 Fix RemoteConnectionManager size() method (#52823)
- [s] c610e0893db Introduce system index APIs for Kibana (#53035)
- [x] a154f9c657d Early return if no global checkpoint listeners (#53036)
- [s] 331d4bb0afe HybridDirectory should mmap postings. (#52641) (#52873)
- [s] 6aa9aaa2c62 Add validation for dynamic templates (#52890)
- [s] 1d1956ee93d Add size support to `top_metrics` (backport of #52662) (#52914)
- [s] 52fa4653003 Cache completion stats between refreshes (#52872)
- [x] 82ab1bc1ff4 Separate translog from index deletion conditions (#52556)
- [x] db6b9c21c71 Use local checkpoint to calculate min translog gen for recovery (#51905)
- [s] be8d704e2b3 Remove seeds depedency for remote cluster settings (#52829)
- [s] 1807f86751a Generalize how queries on `_index` are handled at rewrite time (#52815)
- [x] 9e38125464a Clarify when shard iterators get sorted (#52810)
- [s] d3c0a2f013d Improve the error message when loading text fielddata. (#52753)
- [s] 18663b0a85d Don't index ranges including NOW in percolator (#52748)
- [s] f993ef80f88 Move the terms index of `_id` off-heap. (#52518)
- [s] 96d603979b4 Upgrade Lucene to 8.5.0-snapshot-b01d7cb (#52584)
- [s] 0a09e159594 Add Caching for RepositoryData in BlobStoreRepository (#52341) (#52566)
- [x] 4bb780bc373 Refactor Inflexible Snapshot Repository BwC (#52365) (#52557)
- [x] 3afb5ca1330 Fix synchronization in ByteSizeCachingDirectory (#52512)
- [x] 0c7ae0217de Fix testPrepareIndexForPeerRecovery (#52245)
- [x] 5aa612c2759 Fix testRestoreLocalHistoryFromTranslog (#52441)
- [s] 8d2261fe479 Refactor GeoShapeIndexer by extracting polygon / line decomposers (#52422) (#52506)
- [x] 9d40277d4cb Deciders should not by default collect yes'es (#52438)
- [s] a742c58d45d Extract a ConnectionManager interface (#51722)
- [x] cc628748e10 Optimize FilterStreamInput for Network Reads (#52395) (#52403)
- [s] 146def8caad Implement top_metrics agg (#51155) (#52366)
- [s] 7efce22f19d Fix a DST error in date_histogram (backport #52016) (#52237)
- [s] dac720d7a16 Add a cluster setting to disallow expensive queries (#51385) (#52279)
- [x] 00b90982502 Ignore timeouts with single-node discovery (#52159)
- [s] 350288ddf83 Check dot-index rules after template application (#52087)
- [s] 28a8db730f4 In FieldTypeLookup, factor out flat object field logic. (#52091)
- [x] d8169e5fdcf Don't Upload Redundant Shard Files (#51729) (#52147)
- [x] 90eb6a020da Remove Redundant Loading of RepositoryData during Restore (#51977) (#52108)
- [x] b77ef1f61bc Cleanup some Dead Code in o.e.index.store (#52045) (#52084)
- [x] 337d73a7c6f Rename MapperService#fullName to fieldType.
- [s] 91e938ead81 Add Trace Logging of REST Requests (#51684) (#52015)
- [s] 0f333c89b9e Always rewrite search shard request outside of the search thread pool (#51708) (#51979)
- [x] 8d3e73b3a03 Add host address to BindTransportException message (#51269)
- [s] 337153b29fd Throw better exception on wrong `dynamic_templates` syntax (#51783) // we removed dynamic_templates
- [x] 21224caeaf2 Remove comparison to true for booleans (#51723)
- [x] 39a3a950de0 Simplify rebalancer's weight function (#51632)
- [x] 27c15d6ccd4 Fix InternalEngineTests.testSeqNoAndCheckpoints (#51630) (#51672)
- [s] 86f3b47299b Make `date_range` query rounding consistent with `date` (#50237) (#51741) // no date_range
- [x] 72ae0ca73fe Log exceptions in TcpTransport at DEBUG level (#51612)
- [x] 1064009e9d9 Allow Parallel Snapshot Restore And Delete (#51608) (#51666)
- [s] aae93a75780 Allow Repository Plugins to Filter Metadata on Create (#51472) (#51542) // we haven't added userMetaData yet
- [d] 89c2834b249 Deprecate creation of dot-prefixed index names except for hidden and system indices (#49959)
- [s] 9efa5be60e3 Password-protected Keystore Feature Branch PR (#51123) (#51510)
- [x] 2eeea21d849 Use Consistent ClusterState throughout Snapshot API Calls (#51464) (#51471)
- [x] af1ff52e701 Fix TransportMasterNodeAction not Retrying NodeClosedException (#51325) (#51437)
- [x] f0d8c785e32 Fix Inconsistent Shard Failure Count in Failed Snapshots (#51416) (#51426)
- [x] acf84b68cb0 Do not wrap soft-deletes reader for segment stats (#51331) // applied 24f114766fb
- [x] 4e8ab43a3e6 Simplify Snapshot Initialization (#51256) (#51344)
- [x] 157b352b476 Exclude nested documents in LuceneChangesSnapshot (#51279)
- [x] 7b4c2bfdc4b Fix Overly Optimistic Request Deduplication (#51270) (#51291)
- [x] 43ed244a043 Account soft-deletes in FrozenEngine (#51192) (#51229)
- [x] 694b8ab95dd Fix CorruptedBlobStoreRepository Test (#51128) (#51186)
- [x] 107989df3ee Introduce hidden indices (#51164)
- [x] e51b209dd35 Fix Infinite Retry Loop in loading RepositoryData (#50987) (#51093)
- [x] 4b0581f1824 Remove custom metadata tool (#50813)
- [x] 16c07472e5d Track Snapshot Version in RepositoryData (#50930) (#50989)
- [su] 6e7478b8461 Allow proxy mode server name to be configured (#50951)
- [sn] d8510be3d98 Revert "Send cluster name and discovery node in handshake (#48916)" (#50944)
- [x] b146740e052 Fix queuing in AsyncLucenePersistedState (#50958)
- [x] 16c07472e5d Track Snapshot Version in RepositoryData (#50930) (#50989)
- [x] 91d7b446a0c Warn on slow metadata performance (#50956)
- [x] 22ba759e1f3 Move metadata storage to Lucene (#50928) (From this commit the log is based on the 7.10 branch)
- [x] 0510af87868 Do not force refresh when write indexing buffer (#50769)
- [x] 40801af8840 Import replicated closed dangling indices (#50649)
- [x] fdd413370ef Deleted docs disregarded for if_seq_no check (#50526)
- [x] 4c1f1b2acab Declare remaining parsers `final` (#50571)
- [x] 77fd51f30ba Remove some Dead Code from Discovery Plugins (#50592)
- [x] 671fefaf59e Enhance TransportReplicationAction assertions (#49081)
- [d] 424ed93e38b Always use soft-deletes in InternalEngine (#50415)
- [x] d02afccd983 Ensure relocating shards establish peer recovery retention leases (#50486)
- [sa] 50bd5842c3c Fix testCancelRecoveryDuringPhase1 (#50449)
- [su] 5e0030e1306 Adjust BWC for peer recovery retention leases (#50351)
- [s] a48d19d73a8 Add remote info to the HLRC (#50482)
- [x] 4f24739fbef Fix Index Deletion During Partial Snapshot Create (#50234) (#50266)
- [x] aecbb2f78e6 Fix Index Deletion during Snapshot Finalization (#50202)
- [s] b7ac7324d23 Revert "Add remote info to the HLRC (#49657)"
- [sn] f4989c54c45 Revert "serialize initial_connect_timeout as xcontent correctly"
- [sn] ae64eaabdae serialize initial_connect_timeout as xcontent correctly
- [d] fa1a7c57b8e Add remote info to the HLRC (#49657)
- [x] cec6678587e Use peer recovery retention leases for indices without soft-deletes (#50351)
- [sn] 3b8f5d9ea18 Modify proxy mode to support a single address (#50391)
- [sn] 342a2920a96 Rename the remote connection mode simple to proxy (#50291)
- [d] 2d627ba7574 Add per-field metadata. (#49419)
- [sn] 012746dd816 Send hostname in SNI header in simple remote mode (#50247)
- [su] ee92253f775 Adapt BWC after backporting #50214
- [x] 74ff50f814a Omit loading IndexMetaData when inspecting shards (#50214)
- [sn] 7b863dc25b3 Recovery buffer size 16B smaller (#50100)
- [x] 972b81f8a9d Account trimAboveSeqNo in committed translog generation (#50205)
- [sn] e0e7f1f89a4 Disk threshold decider is enabled by default (#50222)
- [su] 34f83904cc8 Adjust bwc for #48430
- [x] b9fbc8dc748 Migrate peer recovery from translog to retention lease (#49448)
- [sn] 0cedb9e2517 Update remote cluster stats to support simple mode (#49961)
- [sn] 0fae4065eff Better Logging GCS Blobstore Mock (#50102) (#50124)
- [su] c5ecbee224f Update TcpHeader version constant for backport (#50086)
- [x] 1e4d775bfc4 Remove Unused Single Delete in BlobStoreRepository (#50024)
- [su] 1329acc094c Upgrade to lucene 8.4.0-snapshot-662c455. (#50016)
- [sn] 0062d5f301a [DOCS] Remove shadow replica reference (#50029)
- [x] ee4a8a08dd5 Improve Snapshot Finalization Ex. Handling (#49995) (#50017)
- [x] 62e128f02d4 Cleanup Old index-N Blobs in Repository Cleanup (#49862) (#49902)
- [x] 678aeb747ea Make elasticsearch-node tools custom metadata-aware (#48390)
- [x] 87517d96f62 Enable dependent settings values to be validated (#49942)
- [s] fc3454b10bb Randomly run CCR tests with _source disabled (#49922)
- [s] 7f1e1c51a47 Cleanup some in o.e.transport (#49901)
- [x] 8c2dda90c0f Add int indicating size of transport header (#48884)
- [s] fb293adb0f5 Ensure remote strategy settings can be updated (#49772)
- [x] de5eb04f050 Silence lint warnings in server project - part 2 (#49728)
- [x] 8c165e04a1c Replicate write actions before fsyncing them (#49746)
- [x] 944c681680d Make Snapshot Metadata Javadocs Clearer (#49697)
- [x] f8e39d2ff18 New setting to prevent automatically importing dangling indices (#49174)
- [x] 3ad8aa6d465 Remove obsolete resolving logic from TRA (#49685)
- [x] 602e589235d fix mis typo (#49689)
- [s] a354c607228 Revert "Remove obsolete resolving logic from TRA (#49647)"
- [s] 6cca2b04fa0 Remove obsolete resolving logic from TRA (#49647)
- [x] 459d8edcc08 Make BlobStoreRepository Aware of ClusterState (#49639)
- [x] 4b16d50cd4b Fix typo when assigning null_value in GeoPointFieldMapper  (#49645)
- [x] 93dc8941d44 Strengthen validateClusterFormed check (#49248)
- [x] ba5b4f14131 ESIntegTestCase always cleans up static fields (#49105)
- [x] b34daeb64b7 Use Cluster State to Track Repository Generation (#49729)
- [x] 48ba7dde5cc Make BlobStoreRepository#writeIndexGen API Async (#49584)
- [x] 97c7ea60b93 Add Missing Nullable Assertions in SnapshotsService (#49465) (#49492)
- [x] 4d659c4bdbf Make Repository.getRepositoryData an Async API (#49299)
- [x] 9c006483141 Make Snapshot Delete Concurrency Exception Consistent (#49266) (#49281)
- [x] 25cc8e36636 Fix RepoCleanup not Removed on Master-Failover (#49217) (#49239)
- [x] f7d9e7bdc48 Better Exceptions on Concurrent Snapshot Operations (#49220) (#49237)
- [sa] fc505aaa764 Track Repository Gen. in BlobStoreRepository (#48944) (#49116)
- [x] 8402ad95f2b Use ClusterState as Consistency Source for Snapshot Repositories (#49060)
- [x] 0e1035241da Fix Broken Snapshots in Mixed Clusters (#48993) (#48995)
- [x] fc505aaa764 Track Repository Gen. in BlobStoreRepository (#48944) (#49116)
- [sn] c45470f84f4 Fix ShardGenerations in RepositoryData in BwC Case (#48920) (#48947)
- [x] 8360248a43a Always use last properly persisted metadata as previous state (#47779)
- [x] e244d65869c Fix Snapshot Corruption in Edge Case (#47552)
- [x] 38f02217f00 Omit writing index metadata for non-replicated closed indices on data-only node (#47285)
- [x] 4f52ebd32eb Better logging for TLS message on non-secure transport channel (#45835)
- [x] 5ba4f5fb3c9 Use dynamic port ranges for ExternalTestCluster (#45601)
- [x] 722ab70cc96 Make BlobStoreRepository Validation Read master.dat (#45546)
- [x] 29235a637f7 Wait for events in waitForRelocation (#45074)
- [x] 42a331c59ba Remove Unused Features Field on StreamOutput (#44667)
- [x] f20414dd7d9 Optimize some StreamOutput Operations (#44660)
- [x] 4b8fd4e76f1 Remove blobExists Method from BlobContainer (#44472)
- [x] f00b658130d Remove RemoteClusterConnection.ConnectedNodes (#44235)
- [x] 433b3458522 Fix port range allocation with large worker IDs (#44213)
- [x] c40b77b771b Simplify port usage in transport tests (#44157)
- [x] 45b8aca6203 Some Cleanup in Test Framework (#44039)
- [x] e689b20eba8 Add voting-only master node (#43410)
- [x] 3166f7b836c Use unique ports per test worker (#43983)
- [x] 25792d31321 Remove nodeId from BaseNodeRequest (#43658)
- [x] aa12af8a3c4 Enable node roles to be pluggable (#43175)
- [x] 4fd7a22fcfd Allow cluster access during node restart (#42946)
- [x] bc008d8a9db Increase waiting time when check retention locks (#42994)
- [x] fe1674174f6 Remove some leftover refs to minimum_master_nodes (#42700)
- [x] 1b6dc178388 Remove transport client from tests (#42457)
- [x] c459ea828f6 Remove node.max_local_storage_nodes (#42428)
- [x] 39a3d637340 Unguice Snapshot / Restore services (#42357)
- [x] c1de8c29db2 Cluster state from API should always have a master (#42454)
- [x] 749135b37c9 Prevent in-place downgrades and invalid upgrades (#41731)
- [x] 70eb812f83b Remove Delete Method from BlobStore (#41619)
- [x] 328ba09f84b Omit non-masters in ClusterFormationFailureHelper (#41344)
- [x] 2f41b1b64de Remove `Tracer` from `MockTransportService` (#40237)
- [x] 6199ca742f7 Remove Redundant Request Wrappers from RepositoryService (#40192)
- [x] afd42df15f5 Deguice RepositoriesService (#36016)
- [x] 7624734f14b Added wait_for_metadata_version parameter to cluster state api (#35535)
- [x] ebb93db0102 Remove pre 6.0.0 support from InternalEngine (#27720)

Below lists deferred patches. In-between patches that we applied or skipped
are not listed anymore.

- [d] c2deb287f13 Add a cluster setting to disallow loading fielddata on _id field (#49166)
- [d] 725dda37ea5 Flush instead of synced-flush inactive shards (#49126) -- CrateDB 5.0
- [d] b8ce07b4cc5 Pre-sort shards based on the max/min value of the primary sort field (#49092)
- [d] a5f17fc2750 Add preflight check to dynamic mapping updates (#48817)
- [d] 2e7d62c27c9 Geo: improve handling of out of bounds points in linestrings (#47939)
- [d] 54d6da54320 [Java.time] Calculate week of a year with ISO rules (#48209)
- [d] 694373294fe Allow truncation of clean translog (#47866)
- [d] e3adedf610d Geo: implement proper handling of out of bounds geo points (#47734)
- [d] f9cb29450ec Geo: Fixes indexing of linestrings that go around the globe (#47471)
- [d] 8585d58b767 Provide better error when updating geo_shape field mapper settings (#47281)
- [d] 65374c9c010 Tidy up Store#trimUnsafeCommits (#47062)
- [d] 4ab71116688 Geo: fix indexing of west to east linestrings crossing the antimeridian (#46601)
- [d] fab31abbcc0 Log deprecation warning if es.transport.cname_in_publish_address property is specified (#45662)
- [d] e0a2558a4c3 transport.publish_address should contain CNAME (#45626)
- [d] 13a8835e5a8 Geo: Change order of parameter in Geometries to lon, lat (#45332)
- [d] 245cb348d35 Add per-socket keepalive options (#44055)
- [d] b07310022d2 [SPATIAL] New ShapeFieldMapper for indexing cartesian geometries (#44980)
- [d] 7e627d27e5c Geo: move indexShape to AbstractGeometryFieldMapper.Indexer (#44979)
- [d] 94b684630c8 [GEO] Refactor DeprecatedParameters in AbstractGeometryFieldMapper (#44923)
- [d] f603f06250a Geo: refactor geo mapper and query builder (#44884)
- [d] 321c2b86270 Force Merge should reject requests with `only_expunge_deletes` and `max_num_segments` set (#44761)
- [d] fd54e3e8244 Remove support for old translog checkpoint formats (#44272)
- [d] c8ae530e7a6 Don't use index_phrases on graph queries (#44340)
- [d] 33ad7928fbb Geo: extract dateline handling logic from ShapeBuilders (#44187)
- [d] e28fb1f0658 Fix index_prefix sub field name on nested text fields (#43862)
- [d] 56a662ed288 Remove Support for VERSION_CHECKPOINTS Translogs (#42782)
- [d] 6e39433cd53 Remove "nodes/0" folder prefix from data path (#42489)
- [d] 3af0c1746b3 Expose external refreshes through the stats API (#38643)
- [d] ef18d3fb5b2 Add analysis modes to restrict token filter use contexts (#36103)
