.. highlight:: psql
.. _administration-ingestion-rules:

===============
Ingestion Rules
===============

In CrateDB, ingestion rules define where and how the incoming data of a
specific ingestion should be routed and stored.

In this section, we will learn about creating and deleting ingestion rules,
listing the existing ingestion rules and finally the required privileges for
the ``CREATE`` and ``DROP INGEST RULE`` statements, when the
:ref:`administration_user_management` feature is enabled.

Creating and Deleting Ingestion Rules
.....................................

Suppose we have installed an ingestion implementation for an ``mqtt`` broker,
and we would like to filter temperature data streams by topic and store them to
``temp_data.raw``::

    CREATE INGEST RULE temperature
    ON mqtt
    WHERE topic like 'temperature/%'
    INTO temp_data.raw;

It is possible to create and drop ingestion rules even if the corresponding
ingestion implementation is not available. However, the target table
needs to be created manually before the ``CREATE INGEST RULE`` statement is
issued, and it needs to have the same structure as the ingestion
implementation's data structure.

Multiple rules can be created for the same ingestion source, for example, to
store the humidity data streams in ``humidity_data.raw``::

    CREATE INGEST RULE humidity
    ON mqtt
    WHERE topic like 'humidity/%'
    INTO humidity_data.raw;

See :ref:`create-ingest-rule` for more information on ingestion rule creation.

To drop the ``temperature`` ingestion rule created above::

	DROP INGEST RULE temperature;

See :ref:`drop-ingest-rule` for more information on deleting ingestion rules.

Listing Ingestion Rules
.......................

CrateDB exposes ingestion rules ``information_schema.ingestion_rules`` table.

By querying the ``information_schema.ingestion_rules`` table you can get all
information regarding the existing ingestion rules. E.g.::

    cr> SELECT * FROM information_schema.ingestion_rules order by rule_name;
    +-------------+---------------+-------------------+-------------------------+
    | rule_name   | source_ident  | target_table      | condition               |
    +-------------+---------------+-------------------+-------------------------+
    | humidity    | mqtt          | humidity_data.raw | topic like 'humidity/%' |
    +-------------+---------------+-------------------+-------------------------+
    SELECT 1 rows in set (... sec)

The column ``rule_name`` shows the identifier of the rule, the column
``source_ident`` shows the identifier of the ingestion implementation that uses
this rule. The column ``target_table`` identifies the target table where the
data is stored and finally ``condition`` stands for the condition by which the
data is filtered.

Ingestion Rules and Privileges
..............................

When the :ref:`administration_user_management` is enabled, creating and
dropping ingestion rules can only be issued by a superuser.

The default user for the ``INSERT`` operations in the target ``table_ident``
is the superuser ``crate``.

.. SEEALSO::

    :ref:`ingestion` for more information of the ingestion framework.

    :ref:`create-ingest-rule` for more details on creating ingestion rules.

    :ref:`drop-ingest-rule` for more details on deleting ingestion rules.

    :ref:`information_schema_ingest` to list all existing ingestion rules