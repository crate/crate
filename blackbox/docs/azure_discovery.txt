.. highlight:: yaml
.. _azure_discovery:

===============
Azure Discovery
===============

When running Crate on Microsoft Azure you usually face
the problem that Crate's default discovery mechanism does
not work out of the box.

Luckily Crate has a built-in mechanism for unicast host
discovery in an Azure environment.

Requirements to use Azure api for node discovery
------------------------------------------------

The mechanisms for discovery on Microsoft Azure are built
in with Crate, but the required sdk libraries are not included in
any Crate distribution and needed to be added to Crate's
libs folder. By default this is
``$CRATE_HOME/lib``

Please add the following libraries into the libs folder::

    - adal4j-1.0.0.jar
    - azure-core-0.9.3.jar
    - azure-keyvault-core-0.8.0.jar
    - azure-mgmt-compute-0.9.3.jar
    - azure-mgmt-network-0.9.3.jar
    - azure-mgmt-resources-0.9.3.jar
    - azure-mgmt-storage-0.9.3.jar
    - azure-mgmt-utility-0.9.3.jar
    - azure-storage-4.3.0.jar
    - bcprov-jdk15on-1.51.jar
    - commons-io-2.4.jar
    - commons-lang-2.6.jar
    - commons-lang3-3.3.2.jar
    - gson-2.2.4.jar
    - jackson-core-asl-1.9.13.jar
    - jackson-jaxrs-1.9.2.jar
    - jackson-mapper-asl-1.9.13.jar
    - jackson-xc-1.9.2.jar
    - javax.inject-1.jar
    - jaxb-api-2.2.2.jar
    - jaxb-impl-2.2.3-1.jar
    - jcip-annotations-1.0.jar
    - jersey-client-1.13.jar
    - jersey-core-1.13.jar
    - jersey-json-1.13.jar
    - jettison-1.1.jar
    - json-smart-1.1.1.jar
    - lang-tag-1.4.jar
    - nimbus-jose-jwt-3.1.2.jar
    - oauth2-oidc-sdk-4.5.jar
    - stax-api-1.0-2.jar

Basic Configuration
-------------------

The most important step for Azure discovery is that you have to launch your instances within the same vnet or even within
the same subnet. 

Once you have your instances running and Crate installed, you can enable the
Azure discovery by *simply* setting the ``discovery.type`` to ``azure``::

    discovery.type: azure

To be able to use the Azure API, you have to create an ``Active Directory``
application with a password. We recommened to follow the `AD Application Guide`_ .

After the application is created you can add the resourcegroup, the app id, the app secret
and all the required settings to the config,
see :ref:`conf_azure_discovery`.


.. _`AD Application Guide`: https://azure.microsoft.com/en-us/documentation/articles/resource-group-authenticate-service-principal-cli/#_create-ad-application-with-password
